<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料庫清理工具 - 管理員專用</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* 修復捲動問題的關鍵 CSS */
        html, body {
            height: auto !important;
            overflow-y: auto !important;
            margin: 0;
            padding: 0;
        }

        body {
            background: #f0f2f5;
            padding: 20px;
            font-family: "Microsoft JhengHei", sans-serif;
            -webkit-overflow-scrolling: touch; /* 優化手機滑動 */
        }

        /* 按鈕基礎樣式 */
        .btn {
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 卡片 hover 特效 */
        .card {
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* 表格響應式 */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            min-width: 800px;
        }
    </style>
</head>
<body>

    <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 50px;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px;">
            <h1 style="color: #2c3e50; margin: 0 0 15px 0; display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-tools" style="color: #3498db;"></i> 資料庫清理工具
            </h1>
            <p style="color: #e74c3c; font-weight: bold; background: #fff5f5; padding: 12px 20px; border-radius: 8px; border-left: 5px solid #e74c3c; margin: 0;">
                <i class="fas fa-exclamation-triangle"></i> 警告：此工具僅供系統管理員使用，操作前請務必備份資料！
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
            
            <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #3498db; margin-top: 0;"><i class="fas fa-search"></i> 掃描重複 Email</h3>
                <p style="color: #666; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">掃描資料庫中所有重複的 Email 地址，並生成分析報告。</p>
                <button onclick="scanDuplicateEmails()" class="btn" style="background: #3498db; color: white; width: 100%;">
                    開始掃描
                </button>
            </div>

            <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #e67e22; margin-top: 0;"><i class="fas fa-broom"></i> 清理未開通記錄</h3>
                <p style="color: #666; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">自動清理未開通的重複記錄，保留最新的有效資料。</p>
                <button onclick="cleanUnregisteredDuplicates()" class="btn" style="background: #e67e22; color: white; width: 100%;">
                    開始清理
                </button>
            </div>

            <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #27ae60; margin-top: 0;"><i class="fas fa-compress-alt"></i> 智能合併記錄</h3>
                <p style="color: #666; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">智能比對多筆重複記錄，進行資料合併（開發中）。</p>
                <button onclick="smartMergeDuplicates()" class="btn" style="background: #27ae60; color: white; width: 100%;">
                    開始合併
                </button>
            </div>

            <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #9b59b6; margin-top: 0;"><i class="fas fa-download"></i> 匯出問題資料</h3>
                <p style="color: #666; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">匯出所有掃描到的重複 Email 詳細清單為 CSV 格式。</p>
                <button onclick="exportDuplicates()" class="btn" style="background: #9b59b6; color: white; width: 100%;">
                    匯出 CSV
                </button>
            </div>

        </div>

        <div id="resultArea" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; margin-top: 20px;">
            <h3 style="color: #2c3e50; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                <i class="fas fa-list"></i> 操作結果
            </h3>
            <div id="resultContent"></div>
        </div>

        <div id="progressArea" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; margin-top: 20px;">
            <h3 style="color: #2c3e50; margin-top: 0;"><i class="fas fa-spinner fa-spin"></i> 處理中...</h3>
            <div id="progressContent"></div>
            <div style="margin-top: 25px;">
                <div style="background: #ecf0f1; height: 24px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: bold;">
                        0%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let duplicateData = null;

        function showProgress(message, percent = 0) {
            const progressArea = document.getElementById('progressArea');
            const progressContent = document.getElementById('progressContent');
            const progressBar = document.getElementById('progressBar');
            
            progressArea.style.display = 'block';
            progressContent.innerHTML = `<p style="font-size: 1.1rem; color: #555;">${message}</p>`;
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            
            // 讓進度條滾動到視線內
            progressArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideProgress() {
            document.getElementById('progressArea').style.display = 'none';
        }

        function showResult(html) {
            const resultArea = document.getElementById('resultArea');
            const resultContent = document.getElementById('resultContent');
            
            resultArea.style.display = 'block';
            resultContent.innerHTML = html;
            hideProgress();
            
            // 顯示結果後自動滾動到結果區
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- 以下邏輯保持不變，僅微調 HTML 輸出的結構以配合滾動與表格顯示 ---

        async function scanDuplicateEmails() {
            if (!confirm('確定要掃描重複的 Email 嗎？')) return;
            showProgress('正在掃描資料庫...', 10);

            try {
                const snapshot = await db.collection('users').get();
                showProgress('正在分析資料...', 30);

                const emailMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const email = data.email;
                    if (!email) return;
                    if (!emailMap.has(email)) emailMap.set(email, []);
                    emailMap.get(email).push({ id: doc.id, ...data, docId: doc.id });
                });

                showProgress('正在產生報告...', 70);

                const duplicates = [];
                emailMap.forEach((users, email) => {
                    if (users.length > 1) duplicates.push({ email, users });
                });

                duplicateData = duplicates;
                showProgress('完成！', 100);

                let html = `
                    <div style="margin-bottom: 25px; padding: 20px; background: ${duplicates.length > 0 ? '#fff5f5' : '#f0fdf4'}; border-radius: 8px; border-left: 5px solid ${duplicates.length > 0 ? '#e74c3c' : '#22c55e'};">
                        <h4 style="margin: 0 0 10px 0; color: ${duplicates.length > 0 ? '#c0392b' : '#166534'};">
                            ${duplicates.length > 0 ? '⚠️ 發現重複資料' : '✅ 資料正常'}
                        </h4>
                        <p style="margin: 0; color: #444;">
                            共掃描 <strong>${snapshot.size}</strong> 筆記錄，發現 <strong>${duplicates.length}</strong> 個重複的 Email。
                        </p>
                    </div>
                `;

                if (duplicates.length > 0) {
                    html += '<div class="table-container">';
                    duplicates.forEach((dup, index) => {
                        html += `
                            <div style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #fff;">
                                <div style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #e74c3c;"><i class="fas fa-envelope"></i> ${dup.email}</span>
                                    <span style="background: #e74c3c; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem;">${dup.users.length} 筆</span>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f1f3f5; border-bottom: 1px solid #dee2e6;">
                                                <th style="padding: 12px; text-align: left;">文件 ID</th>
                                                <th style="padding: 12px; text-align: left;">姓名/員編</th>
                                                <th style="padding: 12px; text-align: left;">狀態</th>
                                                <th style="padding: 12px; text-align: left;">建立時間</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        dup.users.forEach(user => {
                            const status = user.isRegistered ? 
                                '<b style="color: #27ae60;">已開通</b>' : '<b style="color: #e67e22;">未開通</b>';
                            const createdAt = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleString() : 'N/A';
                            html += `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px; font-family: monospace; font-size: 0.85rem;">${user.docId}</td>
                                    <td style="padding: 10px;">${user.displayName || '無姓名'} (${user.employeeId || '無員編'})</td>
                                    <td style="padding: 10px;">${status}</td>
                                    <td style="padding: 10px; font-size: 0.85rem; color: #666;">${createdAt}</td>
                                </tr>
                            `;
                        });

                        html += `
                                        </tbody>
                                    </table>
                                </div>
                                <div style="padding: 15px; background: #fafafa; border-top: 1px solid #eee;">
                                    <button onclick="fixDuplicateEmail('${dup.email}', ${index})" class="btn" style="background: #27ae60; color: white; font-size: 0.9rem; padding: 8px 15px;">
                                        <i class="fas fa-wrench"></i> 修復此組
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                showResult(html);
            } catch (error) {
                console.error(error);
                showResult(`<div style="color:red; padding:20px;">錯誤：${error.message}</div>`);
            }
        }

        // 功能 2: 清理未開通記錄
        async function cleanUnregisteredDuplicates() {
            if (!duplicateData || duplicateData.length === 0) {
                alert('請先掃描重複資料');
                return;
            }
            if (!confirm('即將刪除所有「未開通」的重複記錄，確定嗎？')) return;

            showProgress('開始清理...', 0);
            try {
                let deletedCount = 0;
                for (let i = 0; i < duplicateData.length; i++) {
                    const dup = duplicateData[i];
                    const percent = ((i + 1) / duplicateData.length) * 100;
                    showProgress(`處理中: ${dup.email}`, percent);

                    const registered = dup.users.filter(u => u.isRegistered && u.uid);
                    const unregistered = dup.users.filter(u => !u.isRegistered || !u.uid);

                    let toDelete = [];
                    if (registered.length > 0) {
                        registered.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        toDelete = [...registered.slice(1), ...unregistered];
                    } else {
                        unregistered.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        toDelete = unregistered.slice(1);
                    }

                    const batch = db.batch();
                    toDelete.forEach(u => {
                        batch.delete(db.collection('users').doc(u.docId));
                        deletedCount++;
                    });
                    if (toDelete.length > 0) await batch.commit();
                }
                showResult(`<div style="padding:20px; background:#f0fdf4; border-radius:8px; color:#166534;">
                    <h4>✅ 清理完成</h4>
                    <p>總計刪除 <strong>${deletedCount}</strong> 筆無效重複記錄。</p>
                </div>`);
                duplicateData = null;
            } catch (error) {
                showResult(`<div style="color:red; padding:20px;">清理失敗：${error.message}</div>`);
            }
        }

        async function smartMergeDuplicates() {
            alert('此功能正在研發中，請先使用「清理未開通記錄」。');
        }

        async function exportDuplicates() {
            if (!duplicateData) { alert('請先掃描'); return; }
            let csv = '\uFEFFEmail,文件ID,員編,姓名,狀態\n';
            duplicateData.forEach(d => {
                d.users.forEach(u => {
                    csv += `${u.email},${u.docId},${u.employeeId},${u.displayName},${u.isRegistered?'已開通':'未開通'}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `重複資料_${new Date().getTime()}.csv`;
            link.click();
        }

        async function fixDuplicateEmail(email, index) {
            const dup = duplicateData[index];
            if(!confirm(`確定要修復 ${email} 嗎？`)) return;
            // 邏輯同 cleanUnregisteredDuplicates 單個版
            showProgress('處理中...', 50);
            try {
                const registered = dup.users.filter(u => u.isRegistered && u.uid);
                const unregistered = dup.users.filter(u => !u.isRegistered || !u.uid);
                let toDelete = registered.length > 0 ? 
                    [...registered.slice(1), ...unregistered] : unregistered.slice(1);

                const batch = db.batch();
                toDelete.forEach(u => batch.delete(db.collection('users').doc(u.docId)));
                if(toDelete.length > 0) await batch.commit();
                
                alert('此組已修復！請重新掃描以更新列表。');
                scanDuplicateEmails();
            } catch(e) { alert(e.message); }
        }

        // 權限檢查
        window.addEventListener('load', async () => {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    alert('請先登入');
                    window.location.href = 'index.html';
                    return;
                }
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                    alert('權限不足');
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>
