<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料庫清理工具 - 管理員專用</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; padding: 20px;">

    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h1 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-tools"></i> 資料庫清理工具
            </h1>
            <p style="color: #e74c3c; font-weight: bold; background: #fee; padding: 10px; border-radius: 4px;">
                ⚠️ 警告：此工具僅供系統管理員使用，操作前請務必備份資料！
            </p>
        </div>

        <!-- 功能選單 -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            
            <!-- 功能 1: 掃描重複 Email -->
            <div class="card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #3498db; margin-bottom: 15px;">
                    <i class="fas fa-search"></i> 掃描重複 Email
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    掃描資料庫中所有重複的 Email 地址
                </p>
                <button onclick="scanDuplicateEmails()" class="btn" style="background: #3498db; color: white; width: 100%;">
                    <i class="fas fa-search"></i> 開始掃描
                </button>
            </div>

            <!-- 功能 2: 清理未開通的舊記錄 -->
            <div class="card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #e67e22; margin-bottom: 15px;">
                    <i class="fas fa-broom"></i> 清理未開通記錄
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    自動清理所有未開通的重複記錄
                </p>
                <button onclick="cleanUnregisteredDuplicates()" class="btn" style="background: #e67e22; color: white; width: 100%;">
                    <i class="fas fa-broom"></i> 開始清理
                </button>
            </div>

            <!-- 功能 3: 合併重複記錄 -->
            <div class="card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #27ae60; margin-bottom: 15px;">
                    <i class="fas fa-compress-alt"></i> 智能合併記錄
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    智能合併重複的 Email 記錄
                </p>
                <button onclick="smartMergeDuplicates()" class="btn" style="background: #27ae60; color: white; width: 100%;">
                    <i class="fas fa-compress-alt"></i> 開始合併
                </button>
            </div>

            <!-- 功能 4: 匯出問題資料 -->
            <div class="card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #9b59b6; margin-bottom: 15px;">
                    <i class="fas fa-download"></i> 匯出問題資料
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    匯出所有重複 Email 的詳細資料
                </p>
                <button onclick="exportDuplicates()" class="btn" style="background: #9b59b6; color: white; width: 100%;">
                    <i class="fas fa-download"></i> 匯出 CSV
                </button>
            </div>

        </div>

        <!-- 結果顯示區 -->
        <div id="resultArea" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">
                <i class="fas fa-list"></i> 操作結果
            </h3>
            <div id="resultContent"></div>
        </div>

        <!-- 進度顯示 -->
        <div id="progressArea" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">
                <i class="fas fa-spinner fa-spin"></i> 處理中...
            </h3>
            <div id="progressContent"></div>
            <div style="margin-top: 20px;">
                <div style="background: #ecf0f1; height: 30px; border-radius: 15px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        0%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let duplicateData = null;

        // 顯示進度
        function showProgress(message, percent = 0) {
            const progressArea = document.getElementById('progressArea');
            const progressContent = document.getElementById('progressContent');
            const progressBar = document.getElementById('progressBar');
            
            progressArea.style.display = 'block';
            progressContent.innerHTML = `<p style="font-size: 1.1rem; color: #555;">${message}</p>`;
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        // 隱藏進度
        function hideProgress() {
            document.getElementById('progressArea').style.display = 'none';
        }

        // 顯示結果
        function showResult(html) {
            const resultArea = document.getElementById('resultArea');
            const resultContent = document.getElementById('resultContent');
            
            resultArea.style.display = 'block';
            resultContent.innerHTML = html;
            hideProgress();
        }

        // 功能 1: 掃描重複 Email
        async function scanDuplicateEmails() {
            if (!confirm('確定要掃描重複的 Email 嗎？')) return;

            showProgress('正在掃描資料庫...', 10);

            try {
                // 取得所有使用者
                const snapshot = await db.collection('users').get();
                showProgress('正在分析資料...', 30);

                // 按 Email 分組
                const emailMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const email = data.email;
                    
                    if (!email) return;
                    
                    if (!emailMap.has(email)) {
                        emailMap.set(email, []);
                    }
                    emailMap.get(email).push({
                        id: doc.id,
                        ...data,
                        docId: doc.id
                    });
                });

                showProgress('正在產生報告...', 70);

                // 找出重複的 Email
                const duplicates = [];
                emailMap.forEach((users, email) => {
                    if (users.length > 1) {
                        duplicates.push({ email, users });
                    }
                });

                duplicateData = duplicates;
                showProgress('完成！', 100);

                // 顯示結果
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: ${duplicates.length > 0 ? '#fee' : '#d4edda'}; border-radius: 4px; border-left: 4px solid ${duplicates.length > 0 ? '#e74c3c' : '#28a745'};">
                        <h4 style="margin: 0 0 10px 0; color: ${duplicates.length > 0 ? '#c0392b' : '#155724'};">
                            ${duplicates.length > 0 ? '⚠️ 發現重複資料' : '✅ 資料正常'}
                        </h4>
                        <p style="margin: 0; color: ${duplicates.length > 0 ? '#721c24' : '#155724'};">
                            共掃描 <strong>${snapshot.size}</strong> 筆記錄，發現 <strong>${duplicates.length}</strong> 個重複的 Email
                        </p>
                    </div>
                `;

                if (duplicates.length > 0) {
                    html += '<div style="margin-top: 20px;"><h4 style="color: #2c3e50;">重複記錄詳情：</h4>';
                    
                    duplicates.forEach((dup, index) => {
                        html += `
                            <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #fafafa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h5 style="margin: 0; color: #e74c3c;">
                                        <i class="fas fa-envelope"></i> ${dup.email}
                                    </h5>
                                    <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: bold;">
                                        ${dup.users.length} 筆重複
                                    </span>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                    <thead>
                                        <tr style="background: #ecf0f1;">
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">文件 ID</th>
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">員工編號</th>
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">姓名</th>
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">狀態</th>
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">UID</th>
                                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">建立時間</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        dup.users.forEach(user => {
                            const status = user.isRegistered ? 
                                '<span style="color: green; font-weight: bold;">已開通</span>' : 
                                '<span style="color: red; font-weight: bold;">未開通</span>';
                            const createdAt = user.createdAt ? 
                                new Date(user.createdAt.toDate()).toLocaleString('zh-TW') : 
                                '未知';
                            
                            html += `
                                <tr style="background: white;">
                                    <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem;">${user.docId}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${user.employeeId || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${user.displayName || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem;">${user.uid || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85rem;">${createdAt}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                                <div style="margin-top: 10px;">
                                    <button onclick="fixDuplicateEmail('${dup.email}', ${index})" class="btn" style="background: #27ae60; color: white; margin-right: 10px;">
                                        <i class="fas fa-wrench"></i> 修復此 Email
                                    </button>
                                    <button onclick="viewDetailedInfo('${dup.email}', ${index})" class="btn" style="background: #3498db; color: white;">
                                        <i class="fas fa-info-circle"></i> 查看詳情
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }

                showResult(html);

            } catch (error) {
                console.error('掃描失敗:', error);
                showResult(`
                    <div style="padding: 20px; background: #fee; border-radius: 4px; border-left: 4px solid #e74c3c; color: #721c24;">
                        <h4 style="margin: 0 0 10px 0;">❌ 掃描失敗</h4>
                        <p style="margin: 0;">${error.message}</p>
                    </div>
                `);
            }
        }

        // 功能 2: 清理未開通的重複記錄
        async function cleanUnregisteredDuplicates() {
            if (!duplicateData || duplicateData.length === 0) {
                alert('請先執行「掃描重複 Email」');
                return;
            }

            const confirmMsg = `即將清理所有未開通的重複記錄。\n\n此操作將：\n1. 保留已開通的記錄\n2. 刪除未開通的重複記錄\n3. 如果都未開通，保留最新的一筆\n\n確定要繼續嗎？`;
            
            if (!confirm(confirmMsg)) return;

            showProgress('正在清理資料...', 0);

            try {
                let totalDeleted = 0;
                let totalKept = 0;
                const results = [];

                for (let i = 0; i < duplicateData.length; i++) {
                    const dup = duplicateData[i];
                    const percent = ((i + 1) / duplicateData.length) * 100;
                    showProgress(`正在處理 ${i + 1}/${duplicateData.length} 個重複 Email...`, percent);

                    // 分類記錄
                    const registered = dup.users.filter(u => u.isRegistered && u.uid);
                    const unregistered = dup.users.filter(u => !u.isRegistered || !u.uid);

                    let toDelete = [];
                    let toKeep = [];

                    if (registered.length > 0) {
                        // 有已開通的記錄：保留最新的已開通記錄，刪除其他所有
                        registered.sort((a, b) => {
                            const timeA = a.activatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                            const timeB = b.activatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                            return timeB - timeA;
                        });
                        
                        toKeep = [registered[0]];
                        toDelete = [...registered.slice(1), ...unregistered];
                    } else {
                        // 都未開通：保留最新的一筆
                        unregistered.sort((a, b) => {
                            const timeA = a.createdAt?.toMillis?.() || 0;
                            const timeB = b.createdAt?.toMillis?.() || 0;
                            return timeB - timeA;
                        });
                        
                        toKeep = [unregistered[0]];
                        toDelete = unregistered.slice(1);
                    }

                    // 執行刪除
                    const batch = db.batch();
                    toDelete.forEach(user => {
                        batch.delete(db.collection('users').doc(user.docId));
                    });

                    if (toDelete.length > 0) {
                        await batch.commit();
                    }

                    totalDeleted += toDelete.length;
                    totalKept += toKeep.length;

                    results.push({
                        email: dup.email,
                        deleted: toDelete.length,
                        kept: toKeep[0]
                    });
                }

                // 顯示結果
                let html = `
                    <div style="padding: 20px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; color: #155724; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0;">✅ 清理完成</h4>
                        <p style="margin: 0;">共處理 ${duplicateData.length} 個重複 Email</p>
                        <p style="margin: 5px 0 0 0;">刪除 <strong>${totalDeleted}</strong> 筆記錄，保留 <strong>${totalKept}</strong> 筆記錄</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>詳細結果：</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #ecf0f1;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Email</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">刪除數量</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">保留記錄</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                results.forEach(r => {
                    html += `
                        <tr style="background: white;">
                            <td style="padding: 10px; border: 1px solid #ddd;">${r.email}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">${r.deleted}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                ${r.kept.displayName || r.kept.employeeId || '-'} 
                                (${r.kept.isRegistered ? '已開通' : '未開通'})
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="scanDuplicateEmails()" class="btn" style="background: #3498db; color: white;">
                            <i class="fas fa-sync"></i> 重新掃描
                        </button>
                    </div>
                `;

                showResult(html);

                // 重新掃描
                duplicateData = null;

            } catch (error) {
                console.error('清理失敗:', error);
                showResult(`
                    <div style="padding: 20px; background: #fee; border-radius: 4px; border-left: 4px solid #e74c3c; color: #721c24;">
                        <h4 style="margin: 0 0 10px 0;">❌ 清理失敗</h4>
                        <p style="margin: 0;">${error.message}</p>
                    </div>
                `);
            }
        }

        // 功能 3: 智能合併記錄
        async function smartMergeDuplicates() {
            if (!duplicateData || duplicateData.length === 0) {
                alert('請先執行「掃描重複 Email」');
                return;
            }

            alert('此功能正在開發中，建議使用「清理未開通記錄」功能。');
        }

        // 功能 4: 匯出問題資料
        async function exportDuplicates() {
            if (!duplicateData || duplicateData.length === 0) {
                alert('請先執行「掃描重複 Email」');
                return;
            }

            showProgress('正在產生 CSV 檔案...', 50);

            try {
                // 產生 CSV 內容
                let csv = '\uFEFFEmail,文件ID,員工編號,姓名,狀態,UID,單位ID,建立時間\n';

                duplicateData.forEach(dup => {
                    dup.users.forEach(user => {
                        const status = user.isRegistered ? '已開通' : '未開通';
                        const createdAt = user.createdAt ? 
                            new Date(user.createdAt.toDate()).toLocaleString('zh-TW') : 
                            '未知';
                        
                        csv += `"${user.email || ''}","${user.docId}","${user.employeeId || ''}","${user.displayName || ''}","${status}","${user.uid || ''}","${user.unitId || ''}","${createdAt}"\n`;
                    });
                });

                // 下載檔案
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `重複Email清單_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showResult(`
                    <div style="padding: 20px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; color: #155724;">
                        <h4 style="margin: 0 0 10px 0;">✅ 匯出成功</h4>
                        <p style="margin: 0;">CSV 檔案已下載完成</p>
                    </div>
                `);

            } catch (error) {
                console.error('匯出失敗:', error);
                showResult(`
                    <div style="padding: 20px; background: #fee; border-radius: 4px; border-left: 4px solid #e74c3c; color: #721c24;">
                        <h4 style="margin: 0 0 10px 0;">❌ 匯出失敗</h4>
                        <p style="margin: 0;">${error.message}</p>
                    </div>
                `);
            }
        }

        // 修復單個重複 Email
        async function fixDuplicateEmail(email, index) {
            const dup = duplicateData[index];
            
            const confirmMsg = `即將修復 Email: ${email}\n\n系統將：\n1. 保留最新的已開通記錄（如有）\n2. 刪除其他重複記錄\n3. 如果都未開通，保留最新的一筆\n\n確定要繼續嗎？`;
            
            if (!confirm(confirmMsg)) return;

            showProgress('正在修復...', 50);

            try {
                // 分類記錄
                const registered = dup.users.filter(u => u.isRegistered && u.uid);
                const unregistered = dup.users.filter(u => !u.isRegistered || !u.uid);

                let toDelete = [];
                let toKeep = [];

                if (registered.length > 0) {
                    registered.sort((a, b) => {
                        const timeA = a.activatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                        const timeB = b.activatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                        return timeB - timeA;
                    });
                    
                    toKeep = [registered[0]];
                    toDelete = [...registered.slice(1), ...unregistered];
                } else {
                    unregistered.sort((a, b) => {
                        const timeA = a.createdAt?.toMillis?.() || 0;
                        const timeB = b.createdAt?.toMillis?.() || 0;
                        return timeB - timeA;
                    });
                    
                    toKeep = [unregistered[0]];
                    toDelete = unregistered.slice(1);
                }

                // 執行刪除
                const batch = db.batch();
                toDelete.forEach(user => {
                    batch.delete(db.collection('users').doc(user.docId));
                });

                if (toDelete.length > 0) {
                    await batch.commit();
                }

                showResult(`
                    <div style="padding: 20px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; color: #155724;">
                        <h4 style="margin: 0 0 10px 0;">✅ 修復成功</h4>
                        <p style="margin: 0;">Email: ${email}</p>
                        <p style="margin: 5px 0 0 0;">刪除 ${toDelete.length} 筆重複記錄，保留 1 筆記錄</p>
                        <div style="margin-top: 15px;">
                            <button onclick="scanDuplicateEmails()" class="btn" style="background: #3498db; color: white;">
                                <i class="fas fa-sync"></i> 重新掃描
                            </button>
                        </div>
                    </div>
                `);

            } catch (error) {
                console.error('修復失敗:', error);
                showResult(`
                    <div style="padding: 20px; background: #fee; border-radius: 4px; border-left: 4px solid #e74c3c; color: #721c24;">
                        <h4 style="margin: 0 0 10px 0;">❌ 修復失敗</h4>
                        <p style="margin: 0;">${error.message}</p>
                    </div>
                `);
            }
        }

        // 查看詳細資訊
        function viewDetailedInfo(email, index) {
            const dup = duplicateData[index];
            
            let html = `
                <div style="padding: 20px; background: #d1ecf1; border-radius: 4px; border-left: 4px solid #17a2b8; color: #0c5460;">
                    <h4 style="margin: 0 0 15px 0;"><i class="fas fa-info-circle"></i> 詳細資訊: ${email}</h4>
            `;

            dup.users.forEach((user, idx) => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 10px;">
                        <h5 style="margin: 0 0 10px 0; color: #2c3e50;">記錄 ${idx + 1}</h5>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td style="padding: 5px; font-weight: bold; width: 150px;">文件 ID:</td><td style="padding: 5px; font-family: monospace;">${user.docId}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">員工編號:</td><td style="padding: 5px;">${user.employeeId || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">姓名:</td><td style="padding: 5px;">${user.displayName || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">Email:</td><td style="padding: 5px;">${user.email || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">狀態:</td><td style="padding: 5px;">${user.isRegistered ? '<span style="color:green;">已開通</span>' : '<span style="color:red;">未開通</span>'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">UID:</td><td style="padding: 5px; font-family: monospace;">${user.uid || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">單位 ID:</td><td style="padding: 5px;">${user.unitId || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">角色:</td><td style="padding: 5px;">${user.role || '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">建立時間:</td><td style="padding: 5px;">${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleString('zh-TW') : '-'}</td></tr>
                            <tr><td style="padding: 5px; font-weight: bold;">開通時間:</td><td style="padding: 5px;">${user.activatedAt ? new Date(user.activatedAt.toDate()).toLocaleString('zh-TW') : '-'}</td></tr>
                        </table>
                    </div>
                `;
            });

            html += `
                    <div style="margin-top: 15px;">
                        <button onclick="scanDuplicateEmails()" class="btn" style="background: #3498db; color: white;">
                            <i class="fas fa-arrow-left"></i> 返回列表
                        </button>
                    </div>
                </div>
            `;

            showResult(html);
        }

        // 檢查權限
        window.addEventListener('load', async () => {
            const user = await new Promise(resolve => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    unsubscribe();
                    resolve(user);
                });
            });

            if (!user) {
                alert('請先登入');
                window.location.href = 'index.html';
                return;
            }

            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                alert('此工具僅供系統管理員使用');
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
