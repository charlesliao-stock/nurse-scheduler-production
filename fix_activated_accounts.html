<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復開通帳號資料</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; padding: 20px;">

    <div style="max-width: 1000px; margin: 0 auto;">
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h1 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-tools"></i> 修復開通帳號資料
            </h1>
            <p style="color: #e74c3c; font-weight: bold; background: #fee; padding: 10px; border-radius: 4px;">
                ⚠️ 此工具用於修復開通後資料遺失的問題（單位、姓名、權限等）
            </p>
        </div>

        <!-- 掃描問題帳號 -->
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">
                <i class="fas fa-search"></i> 掃描問題帳號
            </h3>
            
            <button onclick="scanProblematicAccounts()" id="btnScan" class="btn" 
                    style="background: #3498db; color: white; padding: 12px 20px; font-size: 16px; font-weight: bold;">
                <i class="fas fa-search"></i> 開始掃描
            </button>
        </div>

        <!-- 結果顯示 -->
        <div id="resultArea" style="display: none;"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // 檢查權限
        window.addEventListener('load', async () => {
            const user = await new Promise(resolve => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    unsubscribe();
                    resolve(user);
                });
            });

            if (!user) {
                alert('請先登入');
                window.location.href = 'index.html';
                return;
            }

            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                alert('此工具僅供系統管理員使用');
                window.location.href = 'index.html';
            }
        });

        // 掃描問題帳號
        async function scanProblematicAccounts() {
            const btn = document.getElementById('btnScan');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 掃描中...';

            try {
                console.log('[掃描] 開始掃描已開通的帳號...');
                
                // 取得所有已開通的帳號
                const registeredUsers = await db.collection('users')
                    .where('isRegistered', '==', true)
                    .get();

                const problems = [];
                const total = registeredUsers.size;
                let checked = 0;

                registeredUsers.forEach(doc => {
                    checked++;
                    const data = doc.data();
                    const issues = [];

                    // 檢查關鍵欄位是否遺失
                    if (!data.displayName) issues.push('姓名遺失');
                    if (!data.unitId) issues.push('單位遺失');
                    if (!data.role) issues.push('權限遺失');
                    if (!data.employeeId) issues.push('員工編號遺失');
                    if (!data.level) issues.push('職級遺失');

                    if (issues.length > 0) {
                        problems.push({
                            uid: doc.id,
                            email: data.email,
                            data: data,
                            issues: issues
                        });
                    }
                });

                console.log(`[掃描] 完成：檢查 ${total} 個帳號，發現 ${problems.length} 個問題`);

                // 顯示結果
                displayScanResults(problems, total);

            } catch (error) {
                console.error('[掃描] 失敗:', error);
                alert('掃描失敗: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> 開始掃描';
            }
        }

        // 顯示掃描結果
        function displayScanResults(problems, total) {
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';

            let html = `
                <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">
                        <i class="fas fa-clipboard-list"></i> 掃描結果
                    </h3>
                    
                    <div style="background: ${problems.length > 0 ? '#fee' : '#d4edda'}; padding: 20px; border-radius: 4px; border-left: 4px solid ${problems.length > 0 ? '#e74c3c' : '#28a745'}; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: ${problems.length > 0 ? '#c0392b' : '#155724'};">
                            ${problems.length > 0 ? '⚠️ 發現問題' : '✅ 資料正常'}
                        </h4>
                        <p style="margin: 0; color: ${problems.length > 0 ? '#721c24' : '#155724'};">
                            共檢查 <strong>${total}</strong> 個已開通帳號，發現 <strong>${problems.length}</strong> 個帳號有資料遺失問題
                        </p>
                    </div>
            `;

            if (problems.length > 0) {
                html += '<h4 style="color: #2c3e50; margin-bottom: 15px;">問題帳號列表：</h4>';
                
                problems.forEach((problem, index) => {
                    html += `
                        <div style="background: #fafafa; border: 1px solid #ddd; border-radius: 4px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h5 style="margin: 0 0 5px 0; color: #2c3e50;">
                                        <i class="fas fa-user"></i> ${problem.email || 'Email 未知'}
                                    </h5>
                                    <small style="color: #6c757d; font-family: monospace;">UID: ${problem.uid}</small>
                                </div>
                                <button onclick="fixAccount('${problem.uid}')" class="btn" 
                                        style="background: #27ae60; color: white; padding: 8px 16px;">
                                    <i class="fas fa-wrench"></i> 修復
                                </button>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 3px solid #ffc107;">
                                <strong style="color: #856404;">遺失的資料：</strong>
                                ${problem.issues.map(issue => `<span style="display: inline-block; margin: 5px 5px 0 0; padding: 3px 8px; background: #e74c3c; color: white; border-radius: 3px; font-size: 0.85rem;">${issue}</span>`).join('')}
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <button onclick="viewAccountDetails('${problem.uid}')" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-info-circle"></i> 查看詳情
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                        <button onclick="fixAllAccounts()" class="btn" style="background: #e67e22; color: white; padding: 12px 20px; font-size: 16px; font-weight: bold;">
                            <i class="fas fa-tools"></i> 批次修復所有問題帳號
                        </button>
                        <small style="display: block; margin-top: 10px; color: #999;">
                            ⚠️ 批次修復會嘗試從舊記錄或 Email 還原資料
                        </small>
                    </div>
                `;
            } else {
                html += `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745; margin-bottom: 15px;"></i>
                        <p style="font-size: 1.1rem; margin: 0;">所有已開通帳號的資料都正常！</p>
                    </div>
                `;
            }

            html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="window.location.reload()" class="btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                            <i class="fas fa-redo"></i> 重新掃描
                        </button>
                    </div>
                </div>
            `;

            resultArea.innerHTML = html;
        }

        // 修復單個帳號
        async function fixAccount(uid) {
            if (!confirm(`確定要修復此帳號嗎？\n\nUID: ${uid}\n\n系統將嘗試從舊記錄還原資料。`)) {
                return;
            }

            try {
                console.log('[修復] 開始修復帳號:', uid);
                
                // 取得當前（問題）記錄
                const currentDoc = await db.collection('users').doc(uid).get();
                if (!currentDoc.exists) {
                    alert('找不到此帳號');
                    return;
                }

                const currentData = currentDoc.data();
                console.log('[修復] 當前資料:', currentData);

                // 嘗試找到舊的員工記錄（未開通的）
                const oldRecords = await db.collection('users')
                    .where('email', '==', currentData.email)
                    .where('isRegistered', '==', false)
                    .get();

                if (oldRecords.empty) {
                    alert('找不到舊的員工記錄，無法自動修復。\n\n請手動在 Firestore 中更新資料。');
                    return;
                }

                // 使用第一筆舊記錄的資料
                const oldData = oldRecords.docs[0].data();
                console.log('[修復] 找到舊記錄:', oldData);

                // 合併資料（保留已開通狀態，還原遺失的欄位）
                const fixedData = {
                    ...oldData,          // 舊記錄的完整資料
                    uid: uid,            // 保持當前 UID
                    isRegistered: true,  // 保持已開通狀態
                    activatedAt: currentData.activatedAt || firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                console.log('[修復] 修復後資料:', fixedData);

                // 更新文件
                await db.collection('users').doc(uid).set(fixedData);
                
                // 刪除舊記錄
                const batch = db.batch();
                oldRecords.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                alert('✅ 修復成功！\n\n已還原：\n' +
                      `- 姓名: ${fixedData.displayName}\n` +
                      `- 單位: ${fixedData.unitId}\n` +
                      `- 權限: ${fixedData.role}\n` +
                      `- 職級: ${fixedData.level}`
                );

                // 重新掃描
                setTimeout(() => {
                    scanProblematicAccounts();
                }, 1000);

            } catch (error) {
                console.error('[修復] 失敗:', error);
                alert('修復失敗: ' + error.message);
            }
        }

        // 批次修復所有問題帳號
        async function fixAllAccounts() {
            if (!confirm('確定要批次修復所有問題帳號嗎？\n\n此操作無法復原！')) {
                return;
            }

            alert('此功能正在開發中。\n\n建議使用單個修復功能逐一處理。');
        }

        // 查看帳號詳情
        async function viewAccountDetails(uid) {
            try {
                const doc = await db.collection('users').doc(uid).get();
                if (!doc.exists) {
                    alert('找不到此帳號');
                    return;
                }

                const data = doc.data();
                let details = '帳號詳細資料：\n\n';
                
                Object.keys(data).forEach(key => {
                    let value = data[key];
                    if (value && typeof value === 'object' && value.toDate) {
                        value = value.toDate().toLocaleString('zh-TW');
                    }
                    details += `${key}: ${value || '(空)'}\n`;
                });

                alert(details);
            } catch (error) {
                alert('查看失敗: ' + error.message);
            }
        }
    </script>
</body>
</html>
