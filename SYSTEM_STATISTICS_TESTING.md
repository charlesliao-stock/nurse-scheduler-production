# 系統統計功能測試驗證文檔

## 功能概述

「系統統計」功能提供全面的排班數據分析和 AI 驅動的改進建議。包括：

1. **換班事由分類** - 在換班申請時新增事由分類
2. **統計計算** - 缺班率、修正率、換班統計
3. **AI 分析報告** - 自動生成分析洞察和改進建議
4. **多種呈現方式** - 卡片、表格、圖表
5. **自動化報告生成** - 次月自動生成上月報告

---

## 第一部分：換班事由分類測試

### 測試場景 1.1：新增換班申請

**步驟：**
1. 進入「我的班表」頁面
2. 點擊某個班次的「換班」按鈕
3. 填寫換班申請表單

**預期結果：**
- ✅ 顯示「換班事由」下拉選單，包含 7 個選項：
  - 單位人力調整
  - 公假
  - 病假
  - 喪假
  - 支援
  - 個人因素
  - 其他
- ✅ 選擇「其他」時，顯示「原因說明」必填欄位
- ✅ 保留「換班原因說明」自由輸入欄位

### 測試場景 1.2：驗證換班申請保存

**步驟：**
1. 填寫完整的換班申請（包括事由分類和原因說明）
2. 點擊「提交」按鈕
3. 進入「換班申請列表」查看

**預期結果：**
- ✅ 換班申請成功保存
- ✅ 在列表中顯示換班事由分類
- ✅ 可以查看原因說明

---

## 第二部分：統計計算測試

### 測試場景 2.1：缺班率計算

**測試數據：**
- 月份：2024-01
- 班別需求：
  - 白班（D）：每日 3 人，共 30 天 = 90 班
  - 小夜班（E）：每日 2 人，共 30 天 = 60 班
  - 大夜班（N）：每日 2 人，共 30 天 = 60 班
  - 總計：210 班

**實際排班：**
- 白班：88 人（缺 2 班）
- 小夜班：57 人（缺 3 班）
- 大夜班：59 人（缺 1 班）
- 總計：204 人（缺 6 班）

**預期結果：**
- ✅ 整體缺班率 = 6/210 × 100% = 2.86%
- ✅ 白班缺班率 = 2/90 × 100% = 2.22%
- ✅ 小夜班缺班率 = 3/60 × 100% = 5.0%
- ✅ 大夜班缺班率 = 1/60 × 100% = 1.67%

### 測試場景 2.2：修正率計算

**測試數據：**
- 月份：2024-01
- 總班數：210 班
- 修正次數：20 次

**預期結果：**
- ✅ 修正率 = 20/210 × 100% = 9.52%

### 測試場景 2.3：換班統計

**測試數據：**
- 已批准的換班申請：15 次
  - 單位人力調整：6 次（40%）
  - 個人因素：5 次（33.3%）
  - 病假：2 次（13.3%）
  - 其他：2 次（13.3%）

**預期結果：**
- ✅ 總換班次數 = 15
- ✅ 各事由的計數和百分比正確

---

## 第三部分：AI 分析報告測試

### 測試場景 3.1：缺班率分析

**測試數據：**
- 整體缺班率 = 2.86%（低於 5% 警戒線）

**預期結果：**
- ✅ 生成 INFO 級別洞察：「整體缺班率為 2.86%，保持良好狀態」
- ✅ 不生成改進建議

**測試數據 2：**
- 整體缺班率 = 7.5%（5%-10% 之間）

**預期結果：**
- ✅ 生成 WARNING 級別洞察：「整體缺班率為 7.5%，需要持續監控」
- ✅ 生成改進建議：「⚠️ 缺班率偏高：建議優化排班邏輯」

**測試數據 3：**
- 整體缺班率 = 12%（超過 10% 警戒線）

**預期結果：**
- ✅ 生成 CRITICAL 級別洞察：「整體缺班率達 12%，超過警戒線（10%），需要立即改善」
- ✅ 生成改進建議：「🔴 缺班率過高：建議檢查排班邏輯」

### 測試場景 3.2：修正率分析

**測試數據：**
- 修正率 = 8%（低於 10%）

**預期結果：**
- ✅ 生成 INFO 級別洞察：「修正率為 8%，保持良好狀態」

**測試數據 2：**
- 修正率 = 12%（10%-15% 之間）

**預期結果：**
- ✅ 生成 WARNING 級別洞察：「修正率為 12%，需要持續監控」

**測試數據 3：**
- 修正率 = 18%（超過 15%）

**預期結果：**
- ✅ 生成 CRITICAL 級別洞察：「修正率達 18%，超過警戒線（15%）」
- ✅ 生成改進建議：「🔴 調整班次過多：建議檢查排班規則」

### 測試場景 3.3：班表評分變化分析

**測試數據：**
- 原始評分 = 85 分
- 調整後評分 = 88 分
- 改進 = +3 分

**預期結果：**
- ✅ 生成 INFO 級別洞察：「班表評分從 85 分提升至 88 分，提升 3 分」
- ✅ 生成改進建議：「✅ 班表品質有所改善，調整效果良好」

---

## 第四部分：UI 呈現方式測試

### 測試場景 4.1：卡片式統計（預設）

**步驟：**
1. 進入「系統統計」頁面
2. 選擇單位和月份
3. 點擊「查詢」

**預期結果：**
- ✅ 顯示 9 張卡片：
  - 排班次數
  - 排班時間
  - 原始評分
  - 調整後評分
  - 評分變化
  - 整體缺班率
  - 修正次數
  - 修正率
  - 換班次數
- ✅ 顯示詳細統計表格（班別缺班率、調整原因、換班原因）
- ✅ 顯示 AI 分析報告

### 測試場景 4.2：表格式詳細列表

**步驟：**
1. 進入「系統統計」頁面
2. 在「呈現方式」下拉選單中選擇「表格式詳細列表」
3. 查詢統計資料

**預期結果：**
- ✅ 切換到表格視圖
- ✅ 顯示以下列：
  - 月份
  - 排班次數
  - 排班時間
  - 原始評分
  - 調整後評分
  - 評分變化
  - 缺班率
  - 修正率
  - 換班次數
  - 操作（查看詳情）

### 測試場景 4.3：圖表呈現

**步驟：**
1. 進入「系統統計」頁面
2. 在「呈現方式」下拉選單中選擇「圖表呈現」
3. 查詢統計資料

**預期結果：**
- ✅ 切換到圖表視圖
- ✅ 顯示三個圖表：
  - 班表評分趨勢圖（原始評分 vs 調整後評分）
  - 缺班率趨勢圖（按班別）
  - 修正率趨勢圖
- ✅ 圖表使用顏色編碼（紅/黃/綠）表示嚴重程度

### 測試場景 4.4：CSV 導出

**步驟：**
1. 進入「系統統計」頁面
2. 查詢統計資料
3. 點擊「導出 CSV」按鈕

**預期結果：**
- ✅ 下載 CSV 文件
- ✅ 文件名格式：`統計_YYYY-MM.csv`
- ✅ CSV 包含所有統計指標

---

## 第五部分：自動化報告生成測試

### 測試場景 5.1：手動觸發報告生成

**步驟：**
1. 在瀏覽器控制台執行：
   ```javascript
   automatedReportScheduler.manualTrigger('2024-01');
   ```

**預期結果：**
- ✅ 控制台輸出：「開始生成 2024-01 的統計報告」
- ✅ 為該月份的所有班表生成報告
- ✅ 報告保存到 Firestore
- ✅ 控制台輸出：「✅ 2024-01 的統計報告生成完成」

### 測試場景 5.2：查詢報告生成狀態

**步驟：**
1. 在瀏覽器控制台執行：
   ```javascript
   automatedReportScheduler.getReportStatus('2024-01');
   ```

**預期結果：**
- ✅ 返回報告生成狀態：
  ```javascript
  {
    month: '2024-01',
    totalSchedules: 5,
    reportsGenerated: 5,
    percentage: 100
  }
  ```

### 測試場景 5.3：自動排程驗證

**步驟：**
1. 檢查系統日誌
2. 在每月 1 號凌晨 1 點觀察是否自動執行

**預期結果：**
- ✅ 每月 1 號凌晨 1 點自動執行報告生成
- ✅ 生成上月的統計報告
- ✅ 發送通知給相關單位

---

## 第六部分：邊界情況測試

### 測試場景 6.1：無班表資料

**步驟：**
1. 查詢沒有班表的月份

**預期結果：**
- ✅ 顯示提示：「找不到符合條件的班表資料」

### 測試場景 6.2：無換班申請

**步驟：**
1. 查詢沒有換班申請的班表

**預期結果：**
- ✅ 換班次數顯示為 0
- ✅ 分析報告顯示：「本月無換班申請」

### 測試場景 6.3：跨月份查詢

**步驟：**
1. 在「查詢方式」選擇「區間」
2. 選擇開始月份：2024-01
3. 選擇結束月份：2024-06
4. 點擊「查詢」

**預期結果：**
- ✅ 查詢該時間範圍內的所有班表
- ✅ 顯示統計資料

---

## 測試檢查清單

- [ ] 換班事由分類正確保存
- [ ] 缺班率計算準確
- [ ] 修正率計算準確
- [ ] 換班統計分類準確
- [ ] AI 分析報告生成正確
- [ ] 卡片式統計顯示正常
- [ ] 表格式列表顯示正常
- [ ] 圖表呈現正常
- [ ] CSV 導出功能正常
- [ ] 自動化報告生成功能正常
- [ ] 邊界情況處理正確
- [ ] 性能測試通過（查詢時間 < 2 秒）
- [ ] 跨瀏覽器兼容性測試通過
- [ ] 移動設備適配性測試通過

---

## 已知限制

1. 圖表呈現使用簡單的 SVG，未來可以升級為 Recharts
2. 自動化報告生成需要 Cloud Scheduler 支持
3. 通知功能需要集成 Firebase Cloud Messaging
4. 修正原因分析需要在班表調整時記錄詳細信息

---

## 後續改進建議

1. 集成更高級的圖表庫（Recharts、ECharts）
2. 新增多維度分析（按班別、按員工、按時間段）
3. 支持自定義報告模板
4. 新增數據導出為 Excel 格式
5. 實現實時儀表板
6. 新增預測分析功能
