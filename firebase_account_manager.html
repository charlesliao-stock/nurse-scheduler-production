<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase å¸³è™Ÿç®¡ç†å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            border: none;
            background: transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tool-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .tool-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        
        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result-box.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .result-box.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h4 {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .loading i {
            font-size: 2rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tools"></i> Firebase å¸³è™Ÿç®¡ç†å·¥å…·</h1>
            <p>å®Œæ•´çš„ Firestore èˆ‡ Auth å¸³è™Ÿç®¡ç†ã€è¨ºæ–·èˆ‡ä¿®å¾©å·¥å…·</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">
                <i class="fas fa-chart-pie"></i> ç¸½è¦½
            </button>
            <button class="tab" onclick="switchTab('diagnosis')">
                <i class="fas fa-stethoscope"></i> å¸³è™Ÿè¨ºæ–·
            </button>
            <button class="tab" onclick="switchTab('sync')">
                <i class="fas fa-sync"></i> åŒæ­¥ä¿®å¾©
            </button>
            <button class="tab" onclick="switchTab('cleanup')">
                <i class="fas fa-broom"></i> æ¸…ç†å·¥å…·
            </button>
            <button class="tab" onclick="switchTab('batch')">
                <i class="fas fa-layer-group"></i> æ‰¹æ¬¡æ“ä½œ
            </button>
        </div>
        
        <!-- ç¸½è¦½ Tab -->
        <div id="overview" class="tab-content active">
            <h2 style="margin-bottom: 20px;">ç³»çµ±ç‹€æ…‹ç¸½è¦½</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Firestore è¨˜éŒ„ç¸½æ•¸</h4>
                    <div class="value" id="stat-firestore-total">-</div>
                </div>
                <div class="stat-card" style="border-left-color: #28a745;">
                    <h4>å•Ÿç”¨ä¸­å“¡å·¥</h4>
                    <div class="value" id="stat-firestore-active">-</div>
                </div>
                <div class="stat-card" style="border-left-color: #dc3545;">
                    <h4>å·²åœç”¨å“¡å·¥</h4>
                    <div class="value" id="stat-firestore-inactive">-</div>
                </div>
                <div class="stat-card" style="border-left-color: #ffc107;">
                    <h4>æœ‰ UID çš„è¨˜éŒ„</h4>
                    <div class="value" id="stat-firestore-with-uid">-</div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-exclamation-triangle"></i> æ½›åœ¨å•é¡Œ</h3>
                <div id="issues-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>æ­£åœ¨æƒæ...</p>
                    </div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-redo"></i> å¿«é€Ÿæ“ä½œ</h3>
                <button class="btn btn-primary" onclick="refreshOverview()">
                    <i class="fas fa-sync"></i> é‡æ–°æƒæ
                </button>
                <button class="btn btn-success" onclick="switchTab('diagnosis')">
                    <i class="fas fa-stethoscope"></i> è¨ºæ–·å¸³è™Ÿ
                </button>
                <button class="btn btn-warning" onclick="switchTab('cleanup')">
                    <i class="fas fa-broom"></i> æ¸…ç†é‡è¤‡
                </button>
            </div>
        </div>
        
        <!-- å¸³è™Ÿè¨ºæ–· Tab -->
        <div id="diagnosis" class="tab-content">
            <div class="tool-section">
                <h3><i class="fas fa-search"></i> æŸ¥è©¢å¸³è™Ÿç‹€æ…‹</h3>
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> åŠŸèƒ½èªªæ˜</strong><br>
                    è¼¸å…¥ Email æŸ¥è©¢è©²å¸³è™Ÿåœ¨ Firestore å’Œ Auth çš„å®Œæ•´ç‹€æ…‹ï¼ŒåŒ…æ‹¬æ˜¯å¦åŒæ­¥ã€æ˜¯å¦æœ‰é‡è¤‡è¨˜éŒ„ç­‰ã€‚
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="diagnosisEmail" placeholder="example@hospital.com">
                </div>
                
                <button class="btn btn-primary" onclick="diagnoseAccount()">
                    <i class="fas fa-stethoscope"></i> é–‹å§‹è¨ºæ–·
                </button>
                
                <div id="diagnosisResult" class="result-box"></div>
            </div>
        </div>
        
        <!-- åŒæ­¥ä¿®å¾© Tab -->
        <div id="sync" class="tab-content">
            <div class="tool-section">
                <h3><i class="fas fa-sync"></i> Firestore â†” Auth åŒæ­¥ä¿®å¾©</h3>
                <div class="alert alert-warning">
                    <strong><i class="fas fa-exclamation-triangle"></i> æ³¨æ„</strong><br>
                    æ­¤å·¥å…·æœƒä¿®å¾© Firestore å’Œ Auth ä¹‹é–“çš„ä¸ä¸€è‡´å•é¡Œï¼ŒåŒ…æ‹¬ï¼š<br>
                    â€¢ Firestore æœ‰è¨˜éŒ„ä½† Auth æ²’æœ‰<br>
                    â€¢ Auth æœ‰å¸³è™Ÿä½† Firestore æ²’æœ‰è¨˜éŒ„<br>
                    â€¢ æ–‡ä»¶ ID èˆ‡ UID ä¸ä¸€è‡´
                </div>
                
                <div class="form-group">
                    <label>è¦ä¿®å¾©çš„ Email</label>
                    <input type="email" id="syncEmail" placeholder="example@hospital.com">
                </div>
                
                <button class="btn btn-primary" onclick="syncAccount()">
                    <i class="fas fa-sync"></i> åŸ·è¡ŒåŒæ­¥
                </button>
                
                <div id="syncResult" class="result-box"></div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-magic"></i> è‡ªå‹•ä¿®å¾©æ‰€æœ‰ä¸ä¸€è‡´</h3>
                <div class="alert alert-danger">
                    <strong><i class="fas fa-skull-crossbones"></i> å±éšªæ“ä½œ</strong><br>
                    æ­¤æ“ä½œæœƒæƒæä¸¦è‡ªå‹•ä¿®å¾©æ‰€æœ‰ç™¼ç¾çš„ä¸ä¸€è‡´å•é¡Œã€‚å»ºè­°å…ˆå‚™ä»½è³‡æ–™ã€‚
                </div>
                
                <button class="btn btn-danger" onclick="autoFixAll()">
                    <i class="fas fa-magic"></i> è‡ªå‹•ä¿®å¾©æ‰€æœ‰å•é¡Œ
                </button>
                
                <div id="autoFixResult" class="result-box"></div>
            </div>
        </div>
        
        <!-- æ¸…ç†å·¥å…· Tab -->
        <div id="cleanup" class="tab-content">
            <div class="tool-section">
                <h3><i class="fas fa-copy"></i> æƒæé‡è¤‡ Email</h3>
                <div class="alert alert-info">
                    æ‰¾å‡º Firestore ä¸­æœ‰ç›¸åŒ Email çš„å¤šç­†è¨˜éŒ„ï¼Œå”åŠ©æ¸…ç†é‡è¤‡è³‡æ–™ã€‚
                </div>
                
                <button class="btn btn-primary" onclick="scanDuplicates()">
                    <i class="fas fa-search"></i> é–‹å§‹æƒæ
                </button>
                
                <div id="duplicateResult" class="result-box"></div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-ghost"></i> æƒæå­¤å…’å¸³è™Ÿ</h3>
                <div class="alert alert-info">
                    æ‰¾å‡º Auth ä¸­æœ‰å¸³è™Ÿä½† Firestore æ²’æœ‰å°æ‡‰è¨˜éŒ„çš„ã€Œå­¤å…’å¸³è™Ÿã€ã€‚
                </div>
                
                <div class="alert alert-warning">
                    <strong>æ³¨æ„ï¼š</strong>æ­¤åŠŸèƒ½éœ€è¦ Firebase Admin SDK æˆ–æ‰‹å‹•é€ä¸€æª¢æŸ¥ã€‚
                    ç›®å‰åƒ…èƒ½é€éå·²çŸ¥ Email æ¸…å–®æª¢æŸ¥ã€‚
                </div>
                
                <div class="form-group">
                    <label>å·²çŸ¥ Email æ¸…å–®ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                    <textarea id="orphanEmails" placeholder="email1@hospital.com&#10;email2@hospital.com"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="scanOrphans()">
                    <i class="fas fa-search"></i> æª¢æŸ¥å­¤å…’å¸³è™Ÿ
                </button>
                
                <div id="orphanResult" class="result-box"></div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-trash"></i> åˆªé™¤ Auth å¸³è™Ÿ</h3>
                <div class="alert alert-danger">
                    <strong><i class="fas fa-exclamation-triangle"></i> å±éšªæ“ä½œ</strong><br>
                    åˆªé™¤ Auth å¸³è™Ÿå¾Œç„¡æ³•å¾©åŸã€‚è«‹ç¢ºèªè©²å¸³è™Ÿç¢ºå¯¦ä¸å†éœ€è¦ã€‚
                </div>
                
                <div class="form-group">
                    <label>è¦åˆªé™¤çš„ Email</label>
                    <input type="email" id="deleteAuthEmail" placeholder="example@hospital.com">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="confirmDelete">
                        æˆ‘ç¢ºèªè¦åˆªé™¤æ­¤ Auth å¸³è™Ÿ
                    </label>
                </div>
                
                <button class="btn btn-danger" onclick="deleteAuthAccount()">
                    <i class="fas fa-trash"></i> åˆªé™¤ Auth å¸³è™Ÿ
                </button>
                
                <div id="deleteResult" class="result-box"></div>
            </div>
        </div>
        
        <!-- æ‰¹æ¬¡æ“ä½œ Tab -->
        <div id="batch" class="tab-content">
            <div class="tool-section">
                <h3><i class="fas fa-file-export"></i> åŒ¯å‡ºæ‰€æœ‰å¸³è™Ÿè³‡æ–™</h3>
                <div class="alert alert-info">
                    åŒ¯å‡º Firestore ä¸­æ‰€æœ‰å“¡å·¥çš„è³‡æ–™ç‚º CSV æ ¼å¼ï¼ŒåŒ…å« UIDã€isActive ç­‰è³‡è¨Šã€‚
                </div>
                
                <button class="btn btn-success" onclick="exportAllAccounts()">
                    <i class="fas fa-download"></i> åŒ¯å‡ºç‚º CSV
                </button>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-database"></i> æ‰¹æ¬¡æ›´æ–° UID</h3>
                <div class="alert alert-warning">
                    å°‡æ‰€æœ‰æœ‰ UID ä½†æ–‡ä»¶ ID ä¸ç­‰æ–¼ UID çš„è¨˜éŒ„é·ç§»åˆ°æ­£ç¢ºçš„æ–‡ä»¶ IDã€‚
                </div>
                
                <button class="btn btn-warning" onclick="batchMigrateUIDs()">
                    <i class="fas fa-exchange-alt"></i> æ‰¹æ¬¡é·ç§»
                </button>
                
                <div id="batchMigrateResult" class="result-box"></div>
            </div>
            
            <div class="tool-section">
                <h3><i class="fas fa-shield-alt"></i> é©—è­‰ç³»çµ±å®Œæ•´æ€§</h3>
                <div class="alert alert-info">
                    å…¨é¢æª¢æŸ¥ç³»çµ±çš„è³‡æ–™å®Œæ•´æ€§ï¼ŒåŒ…æ‹¬ï¼š<br>
                    â€¢ æ‰€æœ‰è¨˜éŒ„çš„å¿…è¦æ¬„ä½æ˜¯å¦å®Œæ•´<br>
                    â€¢ UID èˆ‡æ–‡ä»¶ ID æ˜¯å¦ä¸€è‡´<br>
                    â€¢ Email æ ¼å¼æ˜¯å¦æ­£ç¢º<br>
                    â€¢ æ˜¯å¦æœ‰é‡è¤‡è¨˜éŒ„
                </div>
                
                <button class="btn btn-primary" onclick="verifyIntegrity()">
                    <i class="fas fa-check-circle"></i> é–‹å§‹é©—è­‰
                </button>
                
                <div id="verifyResult" class="result-box"></div>
            </div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script>
        // ==================== å·¥å…·å‡½æ•¸ ====================
        
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰ tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰ tab çš„ active class
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„ tab
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab').classList.add('active');
        }
        
        function showResult(elementId, message, type = 'info') {
            const resultBox = document.getElementById(elementId);
            resultBox.className = `result-box ${type}`;
            resultBox.innerHTML = message;
            resultBox.style.display = 'block';
        }
        
        function hideResult(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        // ==================== ç¸½è¦½åŠŸèƒ½ ====================
        
        async function refreshOverview() {
            console.log('[ç¸½è¦½] é–‹å§‹æƒæç³»çµ±ç‹€æ…‹');
            
            try {
                // å–å¾—æ‰€æœ‰ Firestore è¨˜éŒ„
                const snapshot = await db.collection('users').get();
                const allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                
                // çµ±è¨ˆ
                const totalCount = allUsers.length;
                const activeCount = allUsers.filter(u => u.isActive !== false).length;
                const inactiveCount = allUsers.filter(u => u.isActive === false).length;
                const withUidCount = allUsers.filter(u => u.uid).length;
                
                // æ›´æ–°çµ±è¨ˆå¡ç‰‡
                document.getElementById('stat-firestore-total').textContent = totalCount;
                document.getElementById('stat-firestore-active').textContent = activeCount;
                document.getElementById('stat-firestore-inactive').textContent = inactiveCount;
                document.getElementById('stat-firestore-with-uid').textContent = withUidCount;
                
                // æƒæå•é¡Œ
                const issues = [];
                
                // 1. æª¢æŸ¥é‡è¤‡ Email
                const emailMap = {};
                allUsers.forEach(u => {
                    if (u.email) {
                        if (!emailMap[u.email]) {
                            emailMap[u.email] = [];
                        }
                        emailMap[u.email].push(u);
                    }
                });
                
                const duplicateEmails = Object.keys(emailMap).filter(email => emailMap[email].length > 1);
                if (duplicateEmails.length > 0) {
                    issues.push({
                        type: 'warning',
                        icon: 'fa-copy',
                        title: 'ç™¼ç¾é‡è¤‡ Email',
                        message: `${duplicateEmails.length} å€‹ Email æœ‰å¤šç­†è¨˜éŒ„`,
                        action: 'switchTab("cleanup")'
                    });
                }
                
                // 2. æª¢æŸ¥ UID ä¸ä¸€è‡´
                const uidMismatch = allUsers.filter(u => u.uid && u.id !== u.uid);
                if (uidMismatch.length > 0) {
                    issues.push({
                        type: 'danger',
                        icon: 'fa-exclamation-triangle',
                        title: 'æ–‡ä»¶ ID èˆ‡ UID ä¸ä¸€è‡´',
                        message: `${uidMismatch.length} ç­†è¨˜éŒ„éœ€è¦é·ç§»`,
                        action: 'switchTab("batch")'
                    });
                }
                
                // 3. æª¢æŸ¥ç„¡ Email è¨˜éŒ„
                const noEmail = allUsers.filter(u => !u.email);
                if (noEmail.length > 0) {
                    issues.push({
                        type: 'warning',
                        icon: 'fa-envelope',
                        title: 'ç¼ºå°‘ Email',
                        message: `${noEmail.length} ç­†è¨˜éŒ„æ²’æœ‰ Email`
                    });
                }
                
                // 4. æª¢æŸ¥ç„¡ employeeId è¨˜éŒ„
                const noEmpId = allUsers.filter(u => !u.employeeId);
                if (noEmpId.length > 0) {
                    issues.push({
                        type: 'warning',
                        icon: 'fa-id-card',
                        title: 'ç¼ºå°‘å“¡å·¥ç·¨è™Ÿ',
                        message: `${noEmpId.length} ç­†è¨˜éŒ„æ²’æœ‰å“¡å·¥ç·¨è™Ÿ`
                    });
                }
                
                // é¡¯ç¤ºå•é¡Œæ¸…å–®
                const issuesList = document.getElementById('issues-list');
                if (issues.length === 0) {
                    issuesList.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>ç³»çµ±ç‹€æ…‹è‰¯å¥½</strong><br>
                            æœªç™¼ç¾ä»»ä½•å•é¡Œ
                        </div>
                    `;
                } else {
                    let html = '';
                    issues.forEach(issue => {
                        html += `
                            <div class="alert alert-${issue.type}">
                                <i class="fas ${issue.icon}"></i> <strong>${issue.title}</strong><br>
                                ${issue.message}
                                ${issue.action ? `<button class="btn btn-sm btn-primary" onclick="${issue.action}" style="margin-top:10px;">å‰å¾€è™•ç†</button>` : ''}
                            </div>
                        `;
                    });
                    issuesList.innerHTML = html;
                }
                
                console.log('[ç¸½è¦½] æƒæå®Œæˆ');
                
            } catch (error) {
                console.error('[ç¸½è¦½] æƒæå¤±æ•—:', error);
                document.getElementById('issues-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> æƒæå¤±æ•—<br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // ==================== å¸³è™Ÿè¨ºæ–·åŠŸèƒ½ ====================
        
        async function diagnoseAccount() {
            const email = document.getElementById('diagnosisEmail').value.trim();
            
            if (!email) {
                showResult('diagnosisResult', 'âŒ è«‹è¼¸å…¥ Email', 'error');
                return;
            }
            
            showResult('diagnosisResult', '<i class="fas fa-spinner fa-spin"></i> è¨ºæ–·ä¸­...', 'info');
            
            try {
                console.log('[è¨ºæ–·] é–‹å§‹è¨ºæ–·:', email);
                
                // 1. æª¢æŸ¥ Firestore
                const firestoreQuery = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                
                const firestoreDocs = [];
                firestoreQuery.forEach(doc => {
                    firestoreDocs.push({ id: doc.id, ...doc.data() });
                });
                
                // 2. æª¢æŸ¥ Auth
                let authExists = false;
                try {
                    const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                    authExists = signInMethods.length > 0;
                } catch (e) {
                    console.warn('[è¨ºæ–·] Auth æª¢æŸ¥å¤±æ•—:', e);
                }
                
                // 3. ç”Ÿæˆè¨ºæ–·å ±å‘Š
                let report = '<h4>ğŸ“‹ è¨ºæ–·å ±å‘Š</h4>';
                report += '<hr style="margin: 15px 0;">';
                
                // Firestore ç‹€æ…‹
                report += '<h5><i class="fas fa-database"></i> Firestore ç‹€æ…‹</h5>';
                if (firestoreDocs.length === 0) {
                    report += '<p style="color:#dc3545;">âŒ æœªæ‰¾åˆ°è¨˜éŒ„</p>';
                } else if (firestoreDocs.length === 1) {
                    const doc = firestoreDocs[0];
                    report += '<p style="color:#28a745;">âœ“ æ‰¾åˆ° 1 ç­†è¨˜éŒ„</p>';
                    report += `<table>
                        <tr><th>æ¬„ä½</th><th>å€¼</th></tr>
                        <tr><td>æ–‡ä»¶ ID</td><td><code>${doc.id}</code></td></tr>
                        <tr><td>UID</td><td><code>${doc.uid || '(ç„¡)'}</code></td></tr>
                        <tr><td>å“¡å·¥ç·¨è™Ÿ</td><td>${doc.employeeId || '(ç„¡)'}</td></tr>
                        <tr><td>å§“å</td><td>${doc.displayName || '(ç„¡)'}</td></tr>
                        <tr><td>å–®ä½</td><td>${doc.unitId || '(ç„¡)'}</td></tr>
                        <tr><td>ç‹€æ…‹</td><td>${doc.isActive === false ? '<span class="badge badge-danger">å·²åœç”¨</span>' : '<span class="badge badge-success">å•Ÿç”¨ä¸­</span>'}</td></tr>
                        <tr><td>æ–‡ä»¶ ID = UID</td><td>${doc.uid && doc.id === doc.uid ? '<span class="badge badge-success">ä¸€è‡´</span>' : '<span class="badge badge-danger">ä¸ä¸€è‡´</span>'}</td></tr>
                    </table>`;
                } else {
                    report += `<p style="color:#ffc107;">âš ï¸ æ‰¾åˆ° ${firestoreDocs.length} ç­†é‡è¤‡è¨˜éŒ„</p>`;
                    report += '<ul>';
                    firestoreDocs.forEach(doc => {
                        report += `<li>ID: <code>${doc.id}</code>, å§“å: ${doc.displayName}, ç‹€æ…‹: ${doc.isActive === false ? 'å·²åœç”¨' : 'å•Ÿç”¨'}</li>`;
                    });
                    report += '</ul>';
                }
                
                report += '<br><h5><i class="fas fa-key"></i> Auth ç‹€æ…‹</h5>';
                report += authExists 
                    ? '<p style="color:#28a745;">âœ“ Auth å¸³è™Ÿå­˜åœ¨</p>'
                    : '<p style="color:#dc3545;">âŒ Auth å¸³è™Ÿä¸å­˜åœ¨</p>';
                
                // 4. å•é¡Œèˆ‡å»ºè­°
                report += '<br><h5><i class="fas fa-lightbulb"></i> è¨ºæ–·çµè«–</h5>';
                
                if (firestoreDocs.length === 0 && !authExists) {
                    report += '<div class="alert alert-info">æ­¤ Email æœªåœ¨ç³»çµ±ä¸­ä½¿ç”¨ï¼Œå¯ä»¥æ­£å¸¸å»ºç«‹æ–°å¸³è™Ÿã€‚</div>';
                } else if (firestoreDocs.length === 0 && authExists) {
                    report += '<div class="alert alert-danger">å­¤å…’ Auth å¸³è™Ÿï¼šAuth æœ‰å¸³è™Ÿä½† Firestore æ²’æœ‰è¨˜éŒ„ã€‚<br>å»ºè­°åˆªé™¤ Auth å¸³è™Ÿã€‚</div>';
                    report += `<button class="btn btn-danger" onclick="deleteAuthAccountDirect('${email}')"><i class="fas fa-trash"></i> åˆªé™¤ Auth å¸³è™Ÿ</button>`;
                } else if (firestoreDocs.length === 1 && !authExists) {
                    report += '<div class="alert alert-warning">Firestore æœ‰è¨˜éŒ„ä½† Auth æ²’æœ‰å¸³è™Ÿã€‚<br>å“¡å·¥é¦–æ¬¡ç™»å…¥æ™‚æœƒè‡ªå‹•å»ºç«‹ Auth å¸³è™Ÿã€‚</div>';
                } else if (firestoreDocs.length === 1 && authExists) {
                    const doc = firestoreDocs[0];
                    if (doc.id === doc.uid) {
                        report += '<div class="alert alert-success">è³‡æ–™ç‹€æ…‹æ­£å¸¸ï¼Œç„¡éœ€è™•ç†ã€‚</div>';
                    } else {
                        report += '<div class="alert alert-warning">æ–‡ä»¶ ID èˆ‡ UID ä¸ä¸€è‡´ï¼Œå»ºè­°é·ç§»ã€‚</div>';
                        report += `<button class="btn btn-warning" onclick="migrateDocument('${doc.id}', '${doc.uid}')"><i class="fas fa-exchange-alt"></i> åŸ·è¡Œé·ç§»</button>`;
                    }
                } else if (firestoreDocs.length > 1) {
                    report += '<div class="alert alert-danger">ç™¼ç¾é‡è¤‡è¨˜éŒ„ï¼Œéœ€è¦æ¸…ç†ã€‚</div>';
                    report += `<button class="btn btn-danger" onclick="cleanupDuplicates('${email}')"><i class="fas fa-broom"></i> æ¸…ç†é‡è¤‡</button>`;
                }
                
                showResult('diagnosisResult', report, 'info');
                
            } catch (error) {
                console.error('[è¨ºæ–·] å¤±æ•—:', error);
                showResult('diagnosisResult', `âŒ è¨ºæ–·å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        // ==================== åŒæ­¥ä¿®å¾©åŠŸèƒ½ ====================
        
        async function syncAccount() {
            const email = document.getElementById('syncEmail').value.trim();
            
            if (!email) {
                showResult('syncResult', 'âŒ è«‹è¼¸å…¥ Email', 'error');
                return;
            }
            
            showResult('syncResult', '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...', 'info');
            
            try {
                // èª¿ç”¨è¨ºæ–·åŠŸèƒ½çš„é‚è¼¯ï¼Œç„¶å¾Œè‡ªå‹•ä¿®å¾©
                alert('æ­¤åŠŸèƒ½èˆ‡è¨ºæ–·åŠŸèƒ½æ•´åˆï¼Œè«‹ä½¿ç”¨è¨ºæ–·åŠŸèƒ½æŸ¥çœ‹ä¸¦é¸æ“‡ä¿®å¾©æ–¹æ¡ˆã€‚');
                document.getElementById('diagnosisEmail').value = email;
                switchTab('diagnosis');
                diagnoseAccount();
                
            } catch (error) {
                showResult('syncResult', `âŒ åŒæ­¥å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        // ==================== æ¸…ç†å·¥å…·åŠŸèƒ½ ====================
        
        async function scanDuplicates() {
            showResult('duplicateResult', '<i class="fas fa-spinner fa-spin"></i> æƒæä¸­...', 'info');
            
            try {
                const snapshot = await db.collection('users').get();
                const emailMap = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email) {
                        if (!emailMap[data.email]) {
                            emailMap[data.email] = [];
                        }
                        emailMap[data.email].push({ id: doc.id, ...data });
                    }
                });
                
                const duplicates = Object.keys(emailMap).filter(email => emailMap[email].length > 1);
                
                if (duplicates.length === 0) {
                    showResult('duplicateResult', 'âœ… æœªç™¼ç¾é‡è¤‡çš„ Email', 'success');
                    return;
                }
                
                let report = `<h4>æ‰¾åˆ° ${duplicates.length} å€‹é‡è¤‡çš„ Email</h4><hr>`;
                
                duplicates.forEach(email => {
                    const docs = emailMap[email];
                    report += `<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 4px;">`;
                    report += `<h5><i class="fas fa-envelope"></i> ${email}</h5>`;
                    report += `<p>å…± ${docs.length} ç­†è¨˜éŒ„ï¼š</p>`;
                    report += '<table><tr><th>æ–‡ä»¶ ID</th><th>å§“å</th><th>å“¡å·¥ç·¨è™Ÿ</th><th>ç‹€æ…‹</th><th>UID</th><th>æ“ä½œ</th></tr>';
                    
                    docs.forEach(doc => {
                        const statusBadge = doc.isActive === false 
                            ? '<span class="badge badge-danger">å·²åœç”¨</span>'
                            : '<span class="badge badge-success">å•Ÿç”¨</span>';
                        
                        report += `<tr>
                            <td><code>${doc.id}</code></td>
                            <td>${doc.displayName || '-'}</td>
                            <td>${doc.employeeId || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${doc.uid ? '<code>' + doc.uid + '</code>' : '-'}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="deleteFirestoreDoc('${doc.id}')">åˆªé™¤</button></td>
                        </tr>`;
                    });
                    
                    report += '</table>';
                    report += `<button class="btn btn-warning" onclick="cleanupDuplicates('${email}')"><i class="fas fa-broom"></i> è‡ªå‹•æ¸…ç†</button>`;
                    report += '</div>';
                });
                
                showResult('duplicateResult', report, 'warning');
                
            } catch (error) {
                showResult('duplicateResult', `âŒ æƒæå¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        async function cleanupDuplicates(email) {
            if (!confirm(`ç¢ºå®šè¦è‡ªå‹•æ¸…ç† ${email} çš„é‡è¤‡è¨˜éŒ„å—ï¼Ÿ\n\nå°‡ä¿ç•™æœ€æ–°çš„å•Ÿç”¨è¨˜éŒ„ï¼Œåˆªé™¤å…¶ä»–é‡è¤‡é …ã€‚`)) {
                return;
            }
            
            try {
                const snapshot = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                
                const docs = [];
                snapshot.forEach(doc => {
                    docs.push({ id: doc.id, ...doc.data(), ref: doc.ref });
                });
                
                // åˆ†é¡
                const active = docs.filter(d => d.isActive !== false);
                const inactive = docs.filter(d => d.isActive === false);
                
                // ä¿ç•™æœ€æ–°çš„å•Ÿç”¨è¨˜éŒ„
                let keepDoc = null;
                if (active.length > 0) {
                    // æœ‰ UID ä¸” ID = UID çš„å„ªå…ˆ
                    keepDoc = active.find(d => d.uid && d.id === d.uid);
                    if (!keepDoc) {
                        // å¦å‰‡ä¿ç•™æœ€æ–°çš„
                        keepDoc = active.sort((a, b) => {
                            const timeA = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                            const timeB = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                            return timeB - timeA;
                        })[0];
                    }
                } else if (inactive.length > 0) {
                    // å…¨éƒ¨åœç”¨ï¼Œä¿ç•™æœ€æ–°çš„
                    keepDoc = inactive.sort((a, b) => {
                        const timeA = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                        const timeB = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                        return timeB - timeA;
                    })[0];
                }
                
                // åˆªé™¤å…¶ä»–è¨˜éŒ„
                const batch = db.batch();
                let deleteCount = 0;
                
                docs.forEach(doc => {
                    if (doc.id !== keepDoc.id) {
                        batch.delete(doc.ref);
                        deleteCount++;
                    }
                });
                
                await batch.commit();
                
                alert(`âœ… æ¸…ç†å®Œæˆ\n\nä¿ç•™: ${keepDoc.id}\nåˆªé™¤: ${deleteCount} ç­†`);
                
                // é‡æ–°æƒæ
                scanDuplicates();
                
            } catch (error) {
                alert(`âŒ æ¸…ç†å¤±æ•—\n\n${error.message}`);
            }
        }
        
        async function deleteFirestoreDoc(docId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ–‡ä»¶ ${docId}ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                await db.collection('users').doc(docId).delete();
                alert('âœ… åˆªé™¤æˆåŠŸ');
                scanDuplicates();
            } catch (error) {
                alert(`âŒ åˆªé™¤å¤±æ•—\n\n${error.message}`);
            }
        }
        
        async function scanOrphans() {
            const emailsText = document.getElementById('orphanEmails').value.trim();
            
            if (!emailsText) {
                showResult('orphanResult', 'âŒ è«‹è¼¸å…¥è¦æª¢æŸ¥çš„ Email æ¸…å–®', 'error');
                return;
            }
            
            showResult('orphanResult', '<i class="fas fa-spinner fa-spin"></i> æª¢æŸ¥ä¸­...', 'info');
            
            try {
                const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
                const orphans = [];
                
                for (const email of emails) {
                    // æª¢æŸ¥ Auth
                    let authExists = false;
                    try {
                        const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                        authExists = signInMethods.length > 0;
                    } catch (e) {
                        continue;
                    }
                    
                    if (!authExists) continue;
                    
                    // æª¢æŸ¥ Firestore
                    const snapshot = await db.collection('users')
                        .where('email', '==', email)
                        .get();
                    
                    if (snapshot.empty) {
                        orphans.push(email);
                    }
                }
                
                if (orphans.length === 0) {
                    showResult('orphanResult', 'âœ… æœªç™¼ç¾å­¤å…’å¸³è™Ÿ', 'success');
                } else {
                    let report = `<h4>æ‰¾åˆ° ${orphans.length} å€‹å­¤å…’ Auth å¸³è™Ÿ</h4><hr>`;
                    report += '<ul>';
                    orphans.forEach(email => {
                        report += `<li>${email} <button class="btn btn-sm btn-danger" onclick="deleteAuthAccountDirect('${email}')">åˆªé™¤</button></li>`;
                    });
                    report += '</ul>';
                    showResult('orphanResult', report, 'warning');
                }
                
            } catch (error) {
                showResult('orphanResult', `âŒ æª¢æŸ¥å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        async function deleteAuthAccount() {
            const email = document.getElementById('deleteAuthEmail').value.trim();
            const confirmed = document.getElementById('confirmDelete').checked;
            
            if (!email) {
                showResult('deleteResult', 'âŒ è«‹è¼¸å…¥ Email', 'error');
                return;
            }
            
            if (!confirmed) {
                showResult('deleteResult', 'âŒ è«‹å‹¾é¸ç¢ºèªcheckbox', 'error');
                return;
            }
            
            showResult('deleteResult', '<div class="alert alert-danger"><strong>âš ï¸ é‡è¦æé†’</strong><br><br>ç›´æ¥åˆªé™¤ Auth å¸³è™Ÿçš„åŠŸèƒ½éœ€è¦ï¼š<br>1. Firebase Admin SDKï¼ˆå¾Œç«¯ï¼‰<br>2. æˆ–åœ¨ Firebase Console æ‰‹å‹•æ“ä½œ<br><br>å‰ç«¯ç„¡æ³•ç›´æ¥åˆªé™¤å…¶ä»–ä½¿ç”¨è€…çš„ Auth å¸³è™Ÿã€‚<br><br><strong>å»ºè­°æ“ä½œæµç¨‹ï¼š</strong><br>1. å‰å¾€ Firebase Console<br>2. Authentication â†’ Users<br>3. æœå°‹è©² Email<br>4. é»æ“Šåˆªé™¤</div>', 'warning');
        }
        
        async function deleteAuthAccountDirect(email) {
            alert(
                `âš ï¸ ç„¡æ³•ç›´æ¥åˆªé™¤ Auth å¸³è™Ÿ\n\n` +
                `å‰ç«¯ç„¡æ³•ç›´æ¥åˆªé™¤å…¶ä»–ä½¿ç”¨è€…çš„ Auth å¸³è™Ÿã€‚\n\n` +
                `è«‹å‰å¾€ Firebase Consoleï¼š\n` +
                `Authentication â†’ Users â†’ æœå°‹ ${email} â†’ åˆªé™¤`
            );
        }
        
        // ==================== æ‰¹æ¬¡æ“ä½œåŠŸèƒ½ ====================
        
        async function exportAllAccounts() {
            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                // ç”Ÿæˆ CSV
                let csv = 'ID,UID,Email,å“¡å·¥ç·¨è™Ÿ,å§“å,å–®ä½,è·ç´š,è§’è‰²,ç‹€æ…‹\n';
                
                users.forEach(u => {
                    csv += `"${u.id}","${u.uid || ''}","${u.email || ''}","${u.employeeId || ''}","${u.displayName || ''}","${u.unitId || ''}","${u.level || ''}","${u.role || ''}","${u.isActive === false ? 'å·²åœç”¨' : 'å•Ÿç”¨'}"\n`;
                });
                
                // ä¸‹è¼‰
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `å“¡å·¥å¸³è™Ÿè³‡æ–™_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                
                alert(`âœ… åŒ¯å‡ºæˆåŠŸ\n\nå…± ${users.length} ç­†è¨˜éŒ„`);
                
            } catch (error) {
                alert(`âŒ åŒ¯å‡ºå¤±æ•—\n\n${error.message}`);
            }
        }
        
        async function batchMigrateUIDs() {
            if (!confirm('ç¢ºå®šè¦æ‰¹æ¬¡é·ç§»æ‰€æœ‰ UID ä¸ä¸€è‡´çš„è¨˜éŒ„å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒï¼š\n1. å»ºç«‹æ–°æ–‡ä»¶ï¼ˆID = UIDï¼‰\n2. åˆªé™¤èˆŠæ–‡ä»¶')) {
                return;
            }
            
            showResult('batchMigrateResult', '<i class="fas fa-spinner fa-spin"></i> é·ç§»ä¸­...', 'info');
            
            try {
                const snapshot = await db.collection('users').get();
                const toMigrate = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.uid && doc.id !== data.uid) {
                        toMigrate.push({ oldId: doc.id, uid: data.uid, data: data });
                    }
                });
                
                if (toMigrate.length === 0) {
                    showResult('batchMigrateResult', 'âœ… æ²’æœ‰éœ€è¦é·ç§»çš„è¨˜éŒ„', 'success');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const item of toMigrate) {
                    try {
                        const batch = db.batch();
                        
                        // å»ºç«‹æ–°æ–‡ä»¶
                        const newDocRef = db.collection('users').doc(item.uid);
                        batch.set(newDocRef, {
                            ...item.data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // åˆªé™¤èˆŠæ–‡ä»¶
                        batch.delete(db.collection('users').doc(item.oldId));
                        
                        await batch.commit();
                        successCount++;
                        
                    } catch (error) {
                        console.error(`é·ç§»å¤±æ•—: ${item.oldId}`, error);
                        errorCount++;
                    }
                }
                
                showResult('batchMigrateResult', 
                    `âœ… é·ç§»å®Œæˆ<br><br>æˆåŠŸ: ${successCount} ç­†<br>å¤±æ•—: ${errorCount} ç­†`, 
                    errorCount > 0 ? 'warning' : 'success');
                
            } catch (error) {
                showResult('batchMigrateResult', `âŒ é·ç§»å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        async function verifyIntegrity() {
            showResult('verifyResult', '<i class="fas fa-spinner fa-spin"></i> é©—è­‰ä¸­...', 'info');
            
            try {
                const snapshot = await db.collection('users').get();
                const issues = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    if (!data.email) {
                        issues.push({ type: 'error', message: `æ–‡ä»¶ ${docId} ç¼ºå°‘ email` });
                    }
                    if (!data.employeeId) {
                        issues.push({ type: 'warning', message: `æ–‡ä»¶ ${docId} ç¼ºå°‘ employeeId` });
                    }
                    if (!data.displayName) {
                        issues.push({ type: 'warning', message: `æ–‡ä»¶ ${docId} ç¼ºå°‘ displayName` });
                    }
                    
                    // æª¢æŸ¥ Email æ ¼å¼
                    if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                        issues.push({ type: 'error', message: `æ–‡ä»¶ ${docId} çš„ email æ ¼å¼ä¸æ­£ç¢º: ${data.email}` });
                    }
                    
                    // æª¢æŸ¥ UID ä¸€è‡´æ€§
                    if (data.uid && docId !== data.uid) {
                        issues.push({ type: 'warning', message: `æ–‡ä»¶ ${docId} çš„ ID èˆ‡ UID ä¸ä¸€è‡´ (UID: ${data.uid})` });
                    }
                });
                
                let report = `<h4>é©—è­‰å®Œæˆ</h4><hr>`;
                report += `<p>æƒæè¨˜éŒ„æ•¸: ${snapshot.size}</p>`;
                report += `<p>ç™¼ç¾å•é¡Œ: ${issues.length} å€‹</p>`;
                
                if (issues.length === 0) {
                    report += '<div class="alert alert-success"><i class="fas fa-check-circle"></i> è³‡æ–™å®Œæ•´æ€§è‰¯å¥½</div>';
                } else {
                    report += '<h5>å•é¡Œæ¸…å–®ï¼š</h5><ul>';
                    issues.forEach(issue => {
                        const icon = issue.type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
                        const color = issue.type === 'error' ? '#dc3545' : '#ffc107';
                        report += `<li style="color:${color}"><i class="fas ${icon}"></i> ${issue.message}</li>`;
                    });
                    report += '</ul>';
                }
                
                showResult('verifyResult', report, issues.length > 0 ? 'warning' : 'success');
                
            } catch (error) {
                showResult('verifyResult', `âŒ é©—è­‰å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        async function migrateDocument(oldId, uid) {
            if (!confirm(`ç¢ºå®šè¦é·ç§»æ­¤æ–‡ä»¶å—ï¼Ÿ\n\nèˆŠ ID: ${oldId}\næ–° ID: ${uid}`)) {
                return;
            }
            
            try {
                const oldDoc = await db.collection('users').doc(oldId).get();
                if (!oldDoc.exists) {
                    alert('âŒ èˆŠæ–‡ä»¶ä¸å­˜åœ¨');
                    return;
                }
                
                const batch = db.batch();
                
                // å»ºç«‹æ–°æ–‡ä»¶
                const newDocRef = db.collection('users').doc(uid);
                batch.set(newDocRef, {
                    ...oldDoc.data(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // åˆªé™¤èˆŠæ–‡ä»¶
                batch.delete(oldDoc.ref);
                
                await batch.commit();
                
                alert('âœ… é·ç§»æˆåŠŸ');
                diagnoseAccount();
                
            } catch (error) {
                alert(`âŒ é·ç§»å¤±æ•—\n\n${error.message}`);
            }
        }
        
        async function autoFixAll() {
            if (!confirm('âš ï¸ æ­¤æ“ä½œæœƒè‡ªå‹•ä¿®å¾©æ‰€æœ‰ç™¼ç¾çš„å•é¡Œï¼ŒåŒ…æ‹¬ï¼š\n\n1. æ¸…ç†é‡è¤‡ Email\n2. é·ç§» UID ä¸ä¸€è‡´çš„è¨˜éŒ„\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }
            
            showResult('autoFixResult', '<i class="fas fa-spinner fa-spin"></i> è‡ªå‹•ä¿®å¾©ä¸­...', 'info');
            
            try {
                let report = '<h4>è‡ªå‹•ä¿®å¾©å ±å‘Š</h4><hr>';
                
                // 1. æ¸…ç†é‡è¤‡
                report += '<h5>æ­¥é©Ÿ 1: æ¸…ç†é‡è¤‡ Email</h5>';
                const snapshot = await db.collection('users').get();
                const emailMap = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email) {
                        if (!emailMap[data.email]) {
                            emailMap[data.email] = [];
                        }
                        emailMap[data.email].push({ id: doc.id, ...data, ref: doc.ref });
                    }
                });
                
                const duplicates = Object.keys(emailMap).filter(email => emailMap[email].length > 1);
                let cleanupCount = 0;
                
                for (const email of duplicates) {
                    const docs = emailMap[email];
                    const active = docs.filter(d => d.isActive !== false);
                    const keepDoc = active.length > 0 ? active[0] : docs[0];
                    
                    const batch = db.batch();
                    docs.forEach(doc => {
                        if (doc.id !== keepDoc.id) {
                            batch.delete(doc.ref);
                            cleanupCount++;
                        }
                    });
                    
                    await batch.commit();
                }
                
                report += `<p>æ¸…ç†äº† ${cleanupCount} ç­†é‡è¤‡è¨˜éŒ„</p>`;
                
                // 2. é·ç§» UID
                report += '<h5>æ­¥é©Ÿ 2: é·ç§» UID ä¸ä¸€è‡´è¨˜éŒ„</h5>';
                const snapshot2 = await db.collection('users').get();
                let migrateCount = 0;
                
                for (const doc of snapshot2.docs) {
                    const data = doc.data();
                    if (data.uid && doc.id !== data.uid) {
                        const batch = db.batch();
                        batch.set(db.collection('users').doc(data.uid), {
                            ...data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        batch.delete(doc.ref);
                        await batch.commit();
                        migrateCount++;
                    }
                }
                
                report += `<p>é·ç§»äº† ${migrateCount} ç­†è¨˜éŒ„</p>`;
                
                report += '<hr><div class="alert alert-success"><i class="fas fa-check-circle"></i> è‡ªå‹•ä¿®å¾©å®Œæˆ</div>';
                
                showResult('autoFixResult', report, 'success');
                refreshOverview();
                
            } catch (error) {
                showResult('autoFixResult', `âŒ è‡ªå‹•ä¿®å¾©å¤±æ•—<br>${error.message}`, 'error');
            }
        }
        
        // ==================== åˆå§‹åŒ– ====================
        
        window.addEventListener('load', () => {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    alert('è«‹å…ˆç™»å…¥');
                    window.location.href = 'index.html';
                    return;
                }
                
                // æª¢æŸ¥æ¬Šé™
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                    alert('æ­¤å·¥å…·åƒ…é™ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                // è¼‰å…¥ç¸½è¦½
                refreshOverview();
            });
        });
    </script>
</body>
</html>
