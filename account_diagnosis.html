<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號狀態診斷工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* 核心修正：解決無法捲動的問題 */
        html, body {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important; /* 強制啟動垂直捲軸 */
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-overflow-scrolling: touch; /* 優化 iOS 捲動 */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px; /* 底部預留空間 */
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .btn {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: opacity 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }

        input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        input[type="email"]:focus { border-color: #3498db; }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h1 style="color: #2c3e50; margin: 0 0 10px 0; font-size: 1.5rem;">
                <i class="fas fa-stethoscope"></i> 帳號狀態診斷工具
            </h1>
            <p style="color: #666; line-height: 1.6; margin: 0;">
                診斷「Email 已註冊」但無法登入的異常狀態。<br>
                <span style="color: #e74c3c; font-weight: bold;">⚠️ 僅供系統管理員內部調修使用</span>
            </p>
        </div>

        <div class="card">
            <h3 style="color: #2c3e50; margin: 0 0 15px 0;">
                <i class="fas fa-search"></i> 輸入要診斷的 Email
            </h3>
            
            <div style="margin-bottom: 15px;">
                <input type="email" id="diagEmail" placeholder="例如: nurse@hospital.com">
            </div>

            <button onclick="diagnoseAccount()" id="btnDiagnose" class="btn" 
                    style="background: #3498db; color: white; width: 100%; padding: 14px; font-size: 16px; font-weight: bold;">
                <i class="fas fa-stethoscope"></i> 開始檢測
            </button>
        </div>

        <div id="resultArea" style="display: none;"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // 初始化檢查與權限控制
        window.addEventListener('load', async () => {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    alert('請先登入系統');
                    window.location.href = 'index.html';
                    return;
                }
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                    alert('權限不足，僅限管理員訪問');
                    window.location.href = 'index.html';
                }
            });
        });

        async function diagnoseAccount() {
            const email = document.getElementById('diagEmail').value.trim();
            if (!email) return alert('請輸入 Email');
            
            const btn = document.getElementById('btnDiagnose');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> 檢索數據中...';

            try {
                // 1. 檢查 Auth 狀態
                let authMethods = [];
                try {
                    authMethods = await auth.fetchSignInMethodsForEmail(email);
                } catch (e) { console.warn('Auth 檢查受限:', e); }

                // 2. 檢查 Firestore 記錄
                const snapshot = await db.collection('users').where('email', '==', email).get();
                const records = [];
                snapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));

                // 3. 分析
                const diag = analyzeStatus(email, authMethods.length > 0, authMethods, records);
                
                // 4. 渲染
                renderResult(diag);
            } catch (error) {
                console.error(error);
                alert('診斷過程出錯: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-stethoscope"></i> 開始檢測';
            }
        }

        function analyzeStatus(email, authExists, authMethods, records) {
            const res = { email, authExists, authMethods, records, status: '', problem: '', solution: '', actions: [] };

            if (authExists && records.length === 0) {
                res.status = 'orphan_auth';
                res.problem = '孤兒帳號：Auth 有紀錄，但資料庫(Firestore)找不到人。';
                res.solution = '必須刪除 Auth 帳號，讓員工重新點擊開通連結。';
                res.actions = [{ label: '清除 Auth 異常狀態', cmd: 'delAuth', color: '#e74c3c', icon: 'user-slash' }];
            } else if (authExists && records.length > 1) {
                res.status = 'duplicate';
                res.problem = `資料冗餘：發現 ${records.length} 筆重複的 Firestore 資料。`;
                res.solution = '手動保留一筆正確資料，並清除其餘重複項。';
                res.actions = [{ label: '自動清理重複項', cmd: 'clean', color: '#f39c12', icon: 'broom' }];
            } else if (authExists && records.length === 1 && !records[0].isRegistered) {
                res.status = 'incomplete';
                res.problem = '開通中斷：Auth 已建立但資料未同步標記為已開通。';
                res.solution = '刪除 Auth 並讓使用者重跑開通流程。';
                res.actions = [{ label: '重置開通狀態', cmd: 'delAuth', color: '#e74c3c', icon: 'undo' }];
            } else if (!authExists && records.length > 0) {
                res.status = 'ready';
                res.problem = '一切正常：等待使用者首次開通。';
                res.solution = '請使用者去信箱收信，或檢查垃圾信件。';
            } else if (authExists && records.length === 1 && records[0].isRegistered) {
                res.status = 'healthy';
                res.problem = '正常：帳號狀態健康。';
                res.solution = '使用者應可正常登入。若無法登入，請檢查網路或瀏覽器快取。';
            } else {
                res.status = 'missing';
                res.problem = '查無此人：系統中完全沒有這個 Email。';
                res.solution = '請先到「員工管理」新增該位員工。';
            }
            return res;
        }

        function renderResult(diag) {
            const area = document.getElementById('resultArea');
            area.style.display = 'block';

            const config = {
                'healthy': { color: '#27ae60', icon: 'check-circle', label: '狀態健康' },
                'ready': { color: '#3498db', icon: 'clock', label: '待開通' },
                'orphan_auth': { color: '#c0392b', icon: 'ghost', label: 'Auth 孤兒' },
                'incomplete': { color: '#f1c40f', icon: 'exclamation-circle', label: '資料不全' },
                'duplicate': { color: '#e67e22', icon: 'copy', label: '重複資料' },
                'missing': { color: '#95a5a6', icon: 'question-circle', label: '無紀錄' }
            };

            const ui = config[diag.status];

            area.innerHTML = `
                <div class="card" style="border-top: 5px solid ${ui.color}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin:0; color: ${ui.color}"><i class="fas fa-${ui.icon}"></i> ${ui.label}</h3>
                        <span style="font-family: monospace; background: #eee; padding: 2px 8px; border-radius: 4px;">${diag.email}</span>
                    </div>

                    <div style="background: #fdfdfd; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>問題描述：</strong> ${diag.problem}</p>
                        <p><strong>建議方案：</strong> ${diag.solution}</p>
                    </div>

                    ${diag.records.length > 0 ? `
                        <h4 style="margin-bottom:10px;">資料庫詳情 (${diag.records.length})</h4>
                        ${diag.records.map(r => `
                            <div style="font-size: 0.85rem; background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ccc;">
                                <b>ID:</b> ${r.id} | <b>姓名:</b> ${r.displayName || '未填'} <br>
                                <b>開通狀態:</b> ${r.isRegistered ? '✅ 已開通' : '❌ 未開通'} | <b>單位:</b> ${r.unitId || '無'}
                            </div>
                        `).join('')}
                    ` : ''}

                    <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${(diag.actions || []).map(act => `
                            <button onclick="handleAction('${act.cmd}', '${diag.email}')" class="btn" style="background: ${act.color}; color: white; padding: 10px 20px; font-weight: bold;">
                                <i class="fas fa-${act.icon}"></i> ${act.label}
                            </button>
                        `).join('')}
                        <button onclick="window.location.reload()" class="btn" style="background: #666; color: white; padding: 10px 20px;">
                            <i class="fas fa-redo"></i> 重新查詢
                        </button>
                    </div>
                </div>
            `;

            // 修正無法捲動的關鍵：滾動到結果區
            setTimeout(() => {
                window.scrollTo({ top: area.offsetTop - 20, behavior: 'smooth' });
            }, 100);
        }

        async function handleAction(cmd, email) {
            if (cmd === 'delAuth') {
                alert('【管理員操作指引】\n\n由於瀏覽器前端無法直接刪除其他使用者的帳號，請執行：\n1. 前往 Firebase Console -> Authentication\n2. 搜尋 ' + email + '\n3. 點擊刪除\n\n刪除後，該員工即可重新點擊開通信進行註冊。');
            } else if (cmd === 'clean') {
                if (!confirm('確定要清理重複紀錄嗎？系統將保留最新建立的一筆資料。')) return;
                try {
                    const snapshot = await db.collection('users').where('email', '==', email).get();
                    const docs = [];
                    snapshot.forEach(d => docs.push({ ref: d.ref, ts: d.data().createdAt?.toMillis() || 0 }));
                    
                    if (docs.length <= 1) return alert('無需清理');
                    
                    docs.sort((a, b) => b.ts - a.ts); // 按時間降序
                    const batch = db.batch();
                    for (let i = 1; i < docs.length; i++) {
                        batch.delete(docs[i].ref);
                    }
                    await batch.commit();
                    alert('清理成功！');
                    diagnoseAccount();
                } catch (e) { alert('清理失敗: ' + e.message); }
            }
        }
    </script>
</body>
</html>
