<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸³è™Ÿç‹€æ…‹è¨ºæ–·å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; padding: 20px;">

    <div style="max-width: 800px; margin: 0 auto;">
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h1 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-stethoscope"></i> å¸³è™Ÿç‹€æ…‹è¨ºæ–·å·¥å…·
            </h1>
            <p style="color: #666; line-height: 1.6;">
                æ­¤å·¥å…·ç”¨æ–¼è¨ºæ–·å’Œä¿®å¾©ã€ŒEmail å·²è¢«è¨»å†Šã€ä½†å¯¦éš›ä¸Šç„¡æ³•é–‹é€šçš„å•é¡Œã€‚<br>
                <span style="color: #e74c3c; font-weight: bold;">âš ï¸ åƒ…ä¾›ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨</span>
            </p>
        </div>

        <!-- è¨ºæ–·è¡¨å–® -->
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">
                <i class="fas fa-search"></i> è¼¸å…¥è¦è¨ºæ–·çš„ Email
            </h3>
            
            <div style="margin-bottom: 15px;">
                <input type="email" id="diagEmail" placeholder="è¼¸å…¥ Email" 
                       style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>

            <button onclick="diagnoseAccount()" id="btnDiagnose" class="btn" 
                    style="background: #3498db; color: white; width: 100%; padding: 12px; font-size: 16px; font-weight: bold;">
                <i class="fas fa-stethoscope"></i> é–‹å§‹è¨ºæ–·
            </button>
        </div>

        <!-- è¨ºæ–·çµæœ -->
        <div id="resultArea" style="display: none;"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // æª¢æŸ¥æ¬Šé™
        window.addEventListener('load', async () => {
            const user = await new Promise(resolve => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    unsubscribe();
                    resolve(user);
                });
            });

            if (!user) {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'index.html';
                return;
            }

            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'system_admin') {
                alert('æ­¤å·¥å…·åƒ…ä¾›ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨');
                window.location.href = 'index.html';
            }
        });

        // è¨ºæ–·å¸³è™Ÿç‹€æ…‹
        async function diagnoseAccount() {
            const email = document.getElementById('diagEmail').value.trim();
            
            if (!email) {
                alert('è«‹è¼¸å…¥ Email');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Email æ ¼å¼ä¸æ­£ç¢º');
                return;
            }

            const btn = document.getElementById('btnDiagnose');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¨ºæ–·ä¸­...';

            try {
                console.log('[è¨ºæ–·] é–‹å§‹è¨ºæ–·:', email);
                
                // ===== æ­¥é©Ÿ 1: æª¢æŸ¥ Auth ç‹€æ…‹ =====
                console.log('[è¨ºæ–·] æ­¥é©Ÿ 1: æª¢æŸ¥ Auth ç‹€æ…‹...');
                let authExists = false;
                let authMethods = [];
                
                try {
                    const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                    authExists = signInMethods.length > 0;
                    authMethods = signInMethods;
                    console.log('[è¨ºæ–·] Auth ç‹€æ…‹:', authExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                } catch (e) {
                    console.error('[è¨ºæ–·] æª¢æŸ¥ Auth å¤±æ•—:', e);
                }

                // ===== æ­¥é©Ÿ 2: æª¢æŸ¥ Firestore ç‹€æ…‹ =====
                console.log('[è¨ºæ–·] æ­¥é©Ÿ 2: æª¢æŸ¥ Firestore ç‹€æ…‹...');
                const firestoreDocs = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                
                const firestoreRecords = [];
                firestoreDocs.forEach(doc => {
                    firestoreRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('[è¨ºæ–·] Firestore è¨˜éŒ„æ•¸:', firestoreRecords.length);

                // ===== æ­¥é©Ÿ 3: åˆ†æç‹€æ…‹ =====
                const diagnosis = analyzeStatus(email, authExists, authMethods, firestoreRecords);
                
                // ===== é¡¯ç¤ºçµæœ =====
                displayDiagnosis(diagnosis);

            } catch (error) {
                console.error('[è¨ºæ–·] å¤±æ•—:', error);
                showError(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-stethoscope"></i> é–‹å§‹è¨ºæ–·';
            }
        }

        // åˆ†æç‹€æ…‹
        function analyzeStatus(email, authExists, authMethods, firestoreRecords) {
            const diagnosis = {
                email: email,
                authExists: authExists,
                authMethods: authMethods,
                firestoreCount: firestoreRecords.length,
                firestoreRecords: firestoreRecords,
                status: '',
                problem: '',
                solution: '',
                actions: []
            };

            // æƒ…æ³åˆ†æ
            if (authExists && firestoreRecords.length === 0) {
                // ===== å•é¡Œæƒ…æ³ï¼šAuth æœ‰ï¼ŒFirestore æ²’æœ‰ =====
                diagnosis.status = 'orphan_auth';
                diagnosis.problem = 'Auth ç³»çµ±ä¸­æœ‰æ­¤å¸³è™Ÿï¼Œä½† Firestore ä¸­æ²’æœ‰å°æ‡‰çš„è¨˜éŒ„';
                diagnosis.solution = 'åˆªé™¤ Auth ä¸­çš„å­¤å…’å¸³è™Ÿï¼Œè®“ä½¿ç”¨è€…é‡æ–°é–‹é€š';
                diagnosis.actions = [
                    {
                        label: 'åˆªé™¤ Auth å¸³è™Ÿ',
                        action: 'deleteAuthAccount',
                        color: '#e74c3c',
                        icon: 'trash'
                    }
                ];
            } 
            else if (authExists && firestoreRecords.length === 1) {
                const record = firestoreRecords[0];
                
                if (record.isRegistered && record.uid) {
                    // ===== æ­£å¸¸æƒ…æ³ï¼šå·²é–‹é€š =====
                    diagnosis.status = 'registered';
                    diagnosis.problem = 'ç„¡å•é¡Œï¼šå¸³è™Ÿå·²æ­£å¸¸é–‹é€š';
                    diagnosis.solution = 'ä½¿ç”¨è€…å¯ä»¥ç›´æ¥ç™»å…¥';
                    diagnosis.actions = [];
                } else {
                    // ===== å•é¡Œæƒ…æ³ï¼šAuth æœ‰ï¼ŒFirestore æœ‰ä½†æœªé–‹é€š =====
                    diagnosis.status = 'incomplete';
                    diagnosis.problem = 'Auth å¸³è™Ÿå­˜åœ¨ï¼Œä½† Firestore è¨˜éŒ„æœªæ¨™è¨˜ç‚ºå·²é–‹é€š';
                    diagnosis.solution = 'åˆªé™¤ Auth å¸³è™Ÿï¼Œè®“ä½¿ç”¨è€…é‡æ–°é–‹é€šï¼ˆæœƒè‡ªå‹•å®Œæˆè³‡æ–™é·ç§»ï¼‰';
                    diagnosis.actions = [
                        {
                            label: 'åˆªé™¤ Auth å¸³è™Ÿä¸¦é‡ç½®',
                            action: 'deleteAuthAccount',
                            color: '#e74c3c',
                            icon: 'trash'
                        }
                    ];
                }
            }
            else if (authExists && firestoreRecords.length > 1) {
                // ===== å•é¡Œæƒ…æ³ï¼šæœ‰é‡è¤‡è¨˜éŒ„ =====
                diagnosis.status = 'duplicate';
                diagnosis.problem = `Auth å¸³è™Ÿå­˜åœ¨ï¼Œä¸” Firestore æœ‰ ${firestoreRecords.length} ç­†é‡è¤‡è¨˜éŒ„`;
                diagnosis.solution = 'å…ˆæ¸…ç†é‡è¤‡è¨˜éŒ„ï¼Œå†åˆªé™¤ Auth å¸³è™Ÿ';
                diagnosis.actions = [
                    {
                        label: 'æ¸…ç†é‡è¤‡è¨˜éŒ„',
                        action: 'cleanDuplicates',
                        color: '#e67e22',
                        icon: 'broom'
                    },
                    {
                        label: 'åˆªé™¤ Auth å¸³è™Ÿ',
                        action: 'deleteAuthAccount',
                        color: '#e74c3c',
                        icon: 'trash'
                    }
                ];
            }
            else if (!authExists && firestoreRecords.length > 0) {
                // ===== æ­£å¸¸æƒ…æ³ï¼šç­‰å¾…é–‹é€š =====
                diagnosis.status = 'awaiting';
                diagnosis.problem = 'ç„¡å•é¡Œï¼šFirestore æœ‰è¨˜éŒ„ï¼Œç­‰å¾…ä½¿ç”¨è€…é–‹é€š';
                diagnosis.solution = 'ä½¿ç”¨è€…å¯ä»¥æ­£å¸¸é–‹é€š';
                diagnosis.actions = [];
                
                if (firestoreRecords.length > 1) {
                    diagnosis.problem = `æœ‰ ${firestoreRecords.length} ç­†é‡è¤‡çš„æœªé–‹é€šè¨˜éŒ„`;
                    diagnosis.solution = 'å»ºè­°å…ˆæ¸…ç†é‡è¤‡è¨˜éŒ„';
                    diagnosis.actions = [
                        {
                            label: 'æ¸…ç†é‡è¤‡è¨˜éŒ„',
                            action: 'cleanDuplicates',
                            color: '#e67e22',
                            icon: 'broom'
                        }
                    ];
                }
            }
            else {
                // ===== ç•°å¸¸æƒ…æ³ï¼šéƒ½æ²’æœ‰ =====
                diagnosis.status = 'not_found';
                diagnosis.problem = 'æ­¤ Email åœ¨ç³»çµ±ä¸­ä¸å­˜åœ¨';
                diagnosis.solution = 'è«‹ç®¡ç†å“¡å…ˆåœ¨ã€Œäººå“¡ç®¡ç†ã€ä¸­å»ºç«‹å“¡å·¥è³‡æ–™';
                diagnosis.actions = [];
            }

            return diagnosis;
        }

        // é¡¯ç¤ºè¨ºæ–·çµæœ
        function displayDiagnosis(diag) {
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';

            // ç‹€æ…‹é¡è‰²
            const statusColors = {
                'registered': '#28a745',
                'awaiting': '#17a2b8',
                'orphan_auth': '#e74c3c',
                'incomplete': '#ffc107',
                'duplicate': '#e67e22',
                'not_found': '#6c757d'
            };

            const statusIcons = {
                'registered': 'check-circle',
                'awaiting': 'clock',
                'orphan_auth': 'exclamation-triangle',
                'incomplete': 'exclamation-circle',
                'duplicate': 'copy',
                'not_found': 'question-circle'
            };

            const statusNames = {
                'registered': 'âœ… å·²æ­£å¸¸é–‹é€š',
                'awaiting': 'â³ ç­‰å¾…é–‹é€š',
                'orphan_auth': 'âŒ Auth å­¤å…’å¸³è™Ÿ',
                'incomplete': 'âš ï¸ è³‡æ–™ä¸å®Œæ•´',
                'duplicate': 'âš ï¸ é‡è¤‡è¨˜éŒ„',
                'not_found': 'â“ ä¸å­˜åœ¨'
            };

            let html = `
                <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">
                        <i class="fas fa-clipboard-list"></i> è¨ºæ–·å ±å‘Š
                    </h3>

                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #495057;">åŸºæœ¬è³‡è¨Š</h4>
                        <table style="width: 100%; font-size: 0.95rem;">
                            <tr>
                                <td style="padding: 8px 0; font-weight: bold; width: 150px;">Email:</td>
                                <td style="padding: 8px 0;">${diag.email}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; font-weight: bold;">Auth ç‹€æ…‹:</td>
                                <td style="padding: 8px 0;">
                                    ${diag.authExists ? 
                                        '<span style="color: #28a745; font-weight: bold;">âœ“ å·²è¨»å†Š</span>' : 
                                        '<span style="color: #6c757d;">âœ— æœªè¨»å†Š</span>'}
                                    ${diag.authMethods.length > 0 ? 
                                        `<small style="color: #999; margin-left: 10px;">(${diag.authMethods.join(', ')})</small>` : 
                                        ''}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; font-weight: bold;">Firestore è¨˜éŒ„:</td>
                                <td style="padding: 8px 0;">
                                    ${diag.firestoreCount} ç­†
                                    ${diag.firestoreCount > 1 ? 
                                        '<span style="color: #e74c3c; font-weight: bold; margin-left: 10px;">âš  é‡è¤‡</span>' : 
                                        ''}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- ç‹€æ…‹åˆ¤å®š -->
                    <div style="background: ${statusColors[diag.status]}15; border-left: 4px solid ${statusColors[diag.status]}; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: ${statusColors[diag.status]};">
                            <i class="fas fa-${statusIcons[diag.status]}"></i> ${statusNames[diag.status]}
                        </h4>
                        <p style="margin: 0 0 10px 0; color: #495057;"><strong>å•é¡Œï¼š</strong>${diag.problem}</p>
                        <p style="margin: 0; color: #495057;"><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong>${diag.solution}</p>
                    </div>

                    <!-- Firestore è¨˜éŒ„è©³æƒ… -->
                    ${diag.firestoreRecords.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">Firestore è¨˜éŒ„è©³æƒ…</h4>
                            ${diag.firestoreRecords.map((record, idx) => `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #dee2e6;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #2c3e50;">è¨˜éŒ„ ${idx + 1}</strong>
                                        ${record.isRegistered ? 
                                            '<span style="background: #28a745; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">å·²é–‹é€š</span>' : 
                                            '<span style="background: #6c757d; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">æœªé–‹é€š</span>'}
                                    </div>
                                    <table style="width: 100%; font-size: 0.9rem;">
                                        <tr><td style="padding: 5px 0; color: #6c757d; width: 120px;">æ–‡ä»¶ ID:</td><td style="padding: 5px 0; font-family: monospace;">${record.id}</td></tr>
                                        <tr><td style="padding: 5px 0; color: #6c757d;">å“¡å·¥ç·¨è™Ÿ:</td><td style="padding: 5px 0;">${record.employeeId || '-'}</td></tr>
                                        <tr><td style="padding: 5px 0; color: #6c757d;">å§“å:</td><td style="padding: 5px 0;">${record.displayName || '-'}</td></tr>
                                        <tr><td style="padding: 5px 0; color: #6c757d;">UID:</td><td style="padding: 5px 0; font-family: monospace;">${record.uid || '-'}</td></tr>
                                        <tr><td style="padding: 5px 0; color: #6c757d;">å–®ä½:</td><td style="padding: 5px 0;">${record.unitId || '-'}</td></tr>
                                        <tr><td style="padding: 5px 0; color: #6c757d;">å»ºç«‹æ™‚é–“:</td><td style="padding: 5px 0;">${record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('zh-TW') : '-'}</td></tr>
                                    </table>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    ${diag.actions.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">
                                <i class="fas fa-tools"></i> ä¿®å¾©æ“ä½œ
                            </h4>
                            ${diag.actions.map(action => `
                                <button onclick="executeAction('${action.action}', '${diag.email}')" 
                                        class="btn" 
                                        style="background: ${action.color}; color: white; padding: 12px 20px; margin-right: 10px; margin-bottom: 10px; font-weight: bold;">
                                    <i class="fas fa-${action.icon}"></i> ${action.label}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- é‡æ–°è¨ºæ–·æŒ‰éˆ• -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="window.location.reload()" class="btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                            <i class="fas fa-redo"></i> é‡æ–°è¨ºæ–·
                        </button>
                    </div>
                </div>
            `;

            resultArea.innerHTML = html;
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // åŸ·è¡Œä¿®å¾©æ“ä½œ
        async function executeAction(action, email) {
            if (action === 'deleteAuthAccount') {
                await deleteAuthAccount(email);
            } else if (action === 'cleanDuplicates') {
                await cleanDuplicates(email);
            }
        }

        // åˆªé™¤ Auth å¸³è™Ÿï¼ˆéœ€è¦ Admin SDKï¼Œé€™è£¡æä¾›æŒ‡å¼•ï¼‰
        async function deleteAuthAccount(email) {
            const confirmMsg = `âš ï¸ é‡è¦è­¦å‘Š\n\nå³å°‡åˆªé™¤ Auth ç³»çµ±ä¸­çš„å¸³è™Ÿï¼š\n${email}\n\n` +
                               `æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\n` +
                               `æ³¨æ„ï¼šæ­¤æ“ä½œéœ€è¦ä½¿ç”¨ Firebase Admin SDK æˆ– Firebase Console å®Œæˆã€‚\n\n` +
                               `ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            
            if (!confirm(confirmMsg)) return;

            alert(
                'ğŸ”§ åˆªé™¤ Auth å¸³è™Ÿçš„æ­¥é©Ÿï¼š\n\n' +
                'æ–¹æ³• 1: ä½¿ç”¨ Firebase Console\n' +
                '1. å‰å¾€ Firebase Console\n' +
                '2. Authentication â†’ Users\n' +
                '3. æœå°‹ä¸¦æ‰¾åˆ°è©² Email\n' +
                '4. é»æ“Šã€Œ...ã€â†’ã€Œåˆªé™¤å¸³è™Ÿã€\n\n' +
                'æ–¹æ³• 2: ä½¿ç”¨å¯†ç¢¼é‡è¨­\n' +
                '1. ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶\n' +
                '2. ä½¿ç”¨é‡è¨­é€£çµç™»å…¥\n' +
                '3. åœ¨ä½¿ç”¨è€…è¨­å®šä¸­åˆªé™¤å¸³è™Ÿ\n\n' +
                'åˆªé™¤å¾Œï¼Œä½¿ç”¨è€…å³å¯é‡æ–°é–‹é€šã€‚'
            );

            // å˜—è©¦ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶ï¼ˆä½œç‚ºæ›¿ä»£æ–¹æ¡ˆï¼‰
            try {
                await auth.sendPasswordResetEmail(email);
                alert('âœ… å·²ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶åˆ°è©² Email\n\nä½¿ç”¨è€…å¯ä»¥é€ééƒµä»¶é‡è¨­å¯†ç¢¼å¾Œç™»å…¥ã€‚');
            } catch (error) {
                console.error('ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶å¤±æ•—:', error);
            }
        }

        // æ¸…ç†é‡è¤‡è¨˜éŒ„
        async function cleanDuplicates(email) {
            const confirmMsg = `ç¢ºå®šè¦æ¸…ç† Emailã€Œ${email}ã€çš„é‡è¤‡è¨˜éŒ„å—ï¼Ÿ\n\n` +
                               `ç³»çµ±å°‡ï¼š\n` +
                               `1. ä¿ç•™æœ€æ–°çš„ä¸€ç­†è¨˜éŒ„\n` +
                               `2. åˆªé™¤å…¶ä»–é‡è¤‡è¨˜éŒ„\n\n` +
                               `æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
            
            if (!confirm(confirmMsg)) return;

            try {
                const snapshot = await db.collection('users')
                    .where('email', '==', email)
                    .get();

                if (snapshot.empty) {
                    alert('æ‰¾ä¸åˆ°è¨˜éŒ„');
                    return;
                }

                const records = [];
                snapshot.forEach(doc => {
                    records.push({
                        ref: doc.ref,
                        id: doc.id,
                        data: doc.data(),
                        timestamp: doc.data().createdAt?.toMillis?.() || 0
                    });
                });

                // æŒ‰æ™‚é–“æ’åºï¼Œä¿ç•™æœ€æ–°çš„
                records.sort((a, b) => b.timestamp - a.timestamp);
                const toKeep = records[0];
                const toDelete = records.slice(1);

                if (toDelete.length === 0) {
                    alert('æ²’æœ‰é‡è¤‡è¨˜éŒ„éœ€è¦æ¸…ç†');
                    return;
                }

                // åŸ·è¡Œåˆªé™¤
                const batch = db.batch();
                toDelete.forEach(record => {
                    batch.delete(record.ref);
                });

                await batch.commit();

                alert(`âœ… æ¸…ç†å®Œæˆï¼\n\nä¿ç•™: ${toKeep.id}\nåˆªé™¤: ${toDelete.length} ç­†`);

                // é‡æ–°è¨ºæ–·
                setTimeout(() => {
                    diagnoseAccount();
                }, 1000);

            } catch (error) {
                console.error('æ¸…ç†å¤±æ•—:', error);
                alert('æ¸…ç†å¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';
            resultArea.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="background: #fee; border-left: 4px solid #e74c3c; padding: 20px; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #c0392b;">
                            <i class="fas fa-exclamation-triangle"></i> è¨ºæ–·å¤±æ•—
                        </h4>
                        <p style="margin: 0; color: #721c24;">${message}</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
