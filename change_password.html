<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密碼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;">

    <div class="login-card" style="width: 500px; max-width: 100%; padding: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 10px;">
            <i class="fas fa-key"></i> 修改密碼
        </h2>
        
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 30px; text-align: center; line-height: 1.6;">
            為了您的帳號安全，請定期更新密碼
        </p>

        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#333;">
                <i class="fas fa-lock"></i> 目前密碼
            </label>
            <input type="password" id="currentPassword" placeholder="請輸入目前的密碼" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#333;">
                <i class="fas fa-key"></i> 新密碼
            </label>
            <input type="password" id="newPassword" placeholder="請輸入新密碼（至少 8 個字元）" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
            <div id="passwordStrength" style="margin-top:8px;"></div>
        </div>

        <div class="form-group" style="margin-bottom: 25px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#333;">
                <i class="fas fa-check-circle"></i> 確認新密碼
            </label>
            <input type="password" id="confirmPassword" placeholder="請再次輸入新密碼" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
        </div>

        <div style="background:#d1ecf1;padding:15px;border-radius:8px;margin-bottom:25px;border-left:4px solid #17a2b8;">
            <p style="margin:0 0 10px 0;color:#0c5460;font-weight:bold;">
                <i class="fas fa-info-circle"></i> 密碼安全建議
            </p>
            <ul style="margin:0;padding-left:20px;color:#0c5460;font-size:0.9rem;line-height:1.8;">
                <li>長度至少 8 個字元</li>
                <li>包含英文大小寫字母</li>
                <li>包含數字</li>
                <li>避免使用個人資訊（生日、電話等）</li>
            </ul>
        </div>

        <button class="btn btn-primary" onclick="changePassword()" id="btnSubmit" 
                style="width:100%; padding:14px; font-size:16px; font-weight:bold; margin-bottom:15px;">
            <i class="fas fa-save"></i> 儲存新密碼
        </button>

        <button class="btn" onclick="window.history.back()" 
                style="width:100%; padding:12px; background:#6c757d; color:white; font-weight:bold;">
            <i class="fas fa-arrow-left"></i> 返回
        </button>
        
        <div id="msgBox" style="margin-top: 20px; padding: 12px; border-radius: 4px; display:none;">
            <p id="msg" style="margin:0; font-size: 0.9rem; line-height:1.5;"></p>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // 顯示訊息
        function showMessage(text, type = 'info') {
            const msgBox = document.getElementById('msgBox');
            const msg = document.getElementById('msg');
            msgBox.style.display = 'block';
            msg.innerHTML = text;
            
            switch(type) {
                case 'error':
                    msgBox.style.backgroundColor = '#fee';
                    msgBox.style.borderLeft = '4px solid #e74c3c';
                    msgBox.style.color = '#721c24';
                    break;
                case 'success':
                    msgBox.style.backgroundColor = '#d4edda';
                    msgBox.style.borderLeft = '4px solid #28a745';
                    msgBox.style.color = '#155724';
                    break;
                case 'warning':
                    msgBox.style.backgroundColor = '#fff3cd';
                    msgBox.style.borderLeft = '4px solid #ffc107';
                    msgBox.style.color = '#856404';
                    break;
                default:
                    msgBox.style.backgroundColor = '#d1ecf1';
                    msgBox.style.borderLeft = '4px solid #17a2b8';
                    msgBox.style.color = '#0c5460';
            }
        }

        // 檢查密碼強度
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (!password) {
                strengthDiv.innerHTML = '';
                return;
            }

            let strength = 0;
            let tips = [];

            // 長度檢查
            if (password.length >= 8) strength++;
            else tips.push('至少 8 個字元');

            // 大寫字母
            if (/[A-Z]/.test(password)) strength++;
            else tips.push('包含大寫字母');

            // 小寫字母
            if (/[a-z]/.test(password)) strength++;
            else tips.push('包含小寫字母');

            // 數字
            if (/[0-9]/.test(password)) strength++;
            else tips.push('包含數字');

            // 顯示強度
            let color, text;
            if (strength <= 1) {
                color = '#e74c3c';
                text = '弱';
            } else if (strength <= 2) {
                color = '#ffc107';
                text = '中';
            } else if (strength <= 3) {
                color = '#3498db';
                text = '強';
            } else {
                color = '#28a745';
                text = '很強';
            }

            strengthDiv.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="flex:1;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;">
                        <div style="width:${(strength/4)*100}%;height:100%;background:${color};transition:all 0.3s;"></div>
                    </div>
                    <span style="font-size:0.85rem;color:${color};font-weight:bold;">${text}</span>
                </div>
                ${tips.length > 0 ? `<p style="margin:5px 0 0 0;font-size:0.8rem;color:#999;">建議：${tips.join('、')}</p>` : ''}
            `;
        });

        // 修改密碼
        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('btnSubmit');

            // 驗證
            if (!currentPwd || !newPwd || !confirmPwd) {
                showMessage('❌ 請填寫所有欄位', 'error');
                return;
            }

            if (newPwd.length < 8) {
                showMessage('❌ 新密碼長度至少需 8 個字元', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showMessage('❌ 新密碼與確認密碼不符', 'error');
                return;
            }

            if (currentPwd === newPwd) {
                showMessage('❌ 新密碼不可與目前密碼相同', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('請先登入');
                }

                // 重新驗證
                console.log('[修改密碼] 重新驗證身分...');
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPwd
                );
                await user.reauthenticateWithCredential(credential);

                // 更新密碼
                console.log('[修改密碼] 更新密碼...');
                await user.updatePassword(newPwd);

                // 更新 Firestore 標記（表示已修改過密碼）
                console.log('[修改密碼] 更新資料庫標記...');
                await db.collection('users').doc(user.uid).update({
                    passwordChanged: true,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage(
                    '✅ 密碼修改成功！<br><br>' +
                    '系統將在 3 秒後返回...',
                    'success'
                );

                setTimeout(() => {
                    window.history.back();
                }, 3000);

            } catch (error) {
                console.error('[修改密碼] 失敗:', error);
                
                let errorMsg = error.message;
                
                if (error.code === 'auth/wrong-password') {
                    errorMsg = '目前密碼錯誤，請重新輸入';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = '新密碼強度不足';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMsg = '操作逾時，請重新登入後再試';
                }
                
                showMessage('❌ 修改失敗<br><br>' + errorMsg, 'error');
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> 儲存新密碼';
            }
        }

        // 按 Enter 提交
        document.addEventListener('DOMContentLoaded', () => {
            ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') changePassword();
                });
            });
        });

        // 檢查登入狀態
        window.addEventListener('load', () => {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    alert('請先登入');
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>
