<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸³è™Ÿé–‹é€š - æ’ç­ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .signup-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-group input::placeholder {
            color: #aaa;
        }

        .btn-activate {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-activate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }

        .btn-activate:active {
            transform: translateY(0);
        }

        .btn-activate:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 13px;
            color: #555;
            line-height: 1.6;
        }

        .info-box strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .footer-links {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .footer-links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #c33;
            display: none;
        }

        .success-message {
            background: #efe;
            border-left: 4px solid #4f4;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #3c3;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .password-strength {
            margin-top: 8px;
            font-size: 12px;
        }

        .password-strength .bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .password-strength .bar-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .password-strength.weak .bar-fill {
            width: 33%;
            background: #f44;
        }

        .password-strength.medium .bar-fill {
            width: 66%;
            background: #fa4;
        }

        .password-strength.strong .bar-fill {
            width: 100%;
            background: #4f4;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="logo">
            <h1>ğŸ¥ æ’ç­ç³»çµ±</h1>
            <p>å¸³è™Ÿé–‹é€šé é¢</p>
        </div>

        <div class="info-box">
            <strong>ğŸ“‹ é–‹é€šé ˆçŸ¥ï¼š</strong>
            <ul>
                <li>è«‹å‘ç®¡ç†å“¡ç¢ºèªæ‚¨çš„å“¡å·¥ç·¨è™Ÿèˆ‡è¨»å†Š Email</li>
                <li>å¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒï¼Œå»ºè­°ä½¿ç”¨è‹±æ•¸æ··åˆ</li>
                <li>é–‹é€šå¾Œå³å¯ä½¿ç”¨ Email èˆ‡å¯†ç¢¼ç™»å…¥ç³»çµ±</li>
            </ul>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <form id="signupForm">
            <div class="form-group">
                <label for="employeeId">å“¡å·¥ç·¨è™Ÿ *</label>
                <input 
                    type="text" 
                    id="employeeId" 
                    placeholder="è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥ç·¨è™Ÿ" 
                    required
                    autocomplete="off"
                >
            </div>

            <div class="form-group">
                <label for="email">Email *</label>
                <input 
                    type="email" 
                    id="email" 
                    placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡æä¾›çš„ Email" 
                    required
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="password">è¨­å®šå¯†ç¢¼ *</label>
                <input 
                    type="password" 
                    id="password" 
                    placeholder="è«‹è¨­å®šç™»å…¥å¯†ç¢¼ï¼ˆè‡³å°‘ 6 å­—å…ƒï¼‰" 
                    required
                    autocomplete="new-password"
                >
                <div class="password-strength" id="passwordStrength">
                    <div class="bar"><div class="bar-fill"></div></div>
                    <span class="strength-text"></span>
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">ç¢ºèªå¯†ç¢¼ *</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" 
                    required
                    autocomplete="new-password"
                >
            </div>

            <button type="submit" class="btn-activate" id="activateBtn">
                é–‹é€šå¸³è™Ÿ
            </button>
        </form>

        <div class="loading" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <p style="margin-top: 10px; color: #666;">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>

        <div class="footer-links">
            <a href="index.html">â† è¿”å›ç™»å…¥é é¢</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Firebase Config -->
    <script src="js/config.js"></script>

    <script>
        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // UI å…ƒç´ 
        const form = document.getElementById('signupForm');
        const activateBtn = document.getElementById('activateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const passwordInput = document.getElementById('password');
        const passwordStrength = document.getElementById('passwordStrength');

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // 3 ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // è¨­å®šè¼‰å…¥ç‹€æ…‹
        function setLoading(isLoading) {
            if (isLoading) {
                activateBtn.disabled = true;
                activateBtn.textContent = 'è™•ç†ä¸­...';
                loadingIndicator.style.display = 'block';
                form.style.opacity = '0.6';
            } else {
                activateBtn.disabled = false;
                activateBtn.textContent = 'é–‹é€šå¸³è™Ÿ';
                loadingIndicator.style.display = 'none';
                form.style.opacity = '1';
            }
        }

        // å¯†ç¢¼å¼·åº¦æª¢æ¸¬
        passwordInput.addEventListener('input', function() {
            const pwd = this.value;
            const strengthText = passwordStrength.querySelector('.strength-text');
            
            if (pwd.length === 0) {
                passwordStrength.className = 'password-strength';
                strengthText.textContent = '';
                return;
            }

            let strength = 0;
            if (pwd.length >= 6) strength++;
            if (pwd.length >= 8) strength++;
            if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) strength++;
            if (/\d/.test(pwd)) strength++;
            if (/[^a-zA-Z0-9]/.test(pwd)) strength++;

            if (strength <= 2) {
                passwordStrength.className = 'password-strength weak';
                strengthText.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šå¼±';
            } else if (strength <= 3) {
                passwordStrength.className = 'password-strength medium';
                strengthText.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šä¸­';
            } else {
                passwordStrength.className = 'password-strength strong';
                strengthText.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šå¼·';
            }
        });

        // è¡¨å–®æäº¤è™•ç†
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const empId = document.getElementById('employeeId').value.trim();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const pwd = document.getElementById('password').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            // å‰ç«¯é©—è­‰
            if (!empId || !email || !pwd || !confirmPwd) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            if (pwd !== confirmPwd) {
                showError('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼Œè«‹é‡æ–°è¼¸å…¥');
                document.getElementById('confirmPassword').value = '';
                document.getElementById('confirmPassword').focus();
                return;
            }

            if (pwd.length < 6) {
                showError('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }

            setLoading(true);
            errorMessage.style.display = 'none';

            try {
                await activateAccount(empId, email, pwd);
            } catch (error) {
                console.error('é–‹é€šå¤±æ•—:', error);
                showError(error.message || 'é–‹é€šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                setLoading(false);
            }
        });

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šå¸³è™Ÿé–‹é€š ===
        async function activateAccount(empId, email, pwd) {
            let userCredential = null;
            let oldDocRef = null;

            try {
                // Step 1: æŸ¥è©¢ Firestore æš«å­˜è¨˜éŒ„
                console.log('[é–‹é€šæµç¨‹] Step 1: æŸ¥è©¢æš«å­˜è¨˜éŒ„...');
                const snapshot = await db.collection('users')
                    .where('employeeId', '==', empId)
                    .where('email', '==', email)
                    .get();

                if (snapshot.empty) {
                    throw new Error('æ‰¾ä¸åˆ°å°æ‡‰çš„å¸³è™Ÿè³‡æ–™ï¼Œè«‹ç¢ºèªå“¡å·¥ç·¨è™Ÿèˆ‡ Email æ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯çµ¡ç®¡ç†å“¡');
                }

                if (snapshot.size > 1) {
                    console.warn('[é–‹é€šæµç¨‹] è­¦å‘Šï¼šç™¼ç¾å¤šç­†ç›¸åŒå“¡ç·¨+Email çš„è¨˜éŒ„');
                }

                const oldDoc = snapshot.docs[0];
                oldDocRef = oldDoc.ref;
                const userData = oldDoc.data();

                console.log('[é–‹é€šæµç¨‹] æ‰¾åˆ°æš«å­˜è¨˜éŒ„:', userData);

                // Step 2: é©—è­‰æ˜¯å¦å·²é–‹é€š
                if (userData.isRegistered && userData.uid) {
                    throw new Error('æ­¤å¸³è™Ÿå·²ç¶“é–‹é€šï¼Œè«‹ç›´æ¥å‰å¾€ç™»å…¥é é¢ä½¿ç”¨æ‚¨çš„ Email èˆ‡å¯†ç¢¼ç™»å…¥');
                }

                // Step 3: å»ºç«‹ Firebase Auth å¸³è™Ÿ
                console.log('[é–‹é€šæµç¨‹] Step 2: å»ºç«‹ Firebase Auth å¸³è™Ÿ...');
                try {
                    userCredential = await auth.createUserWithEmailAndPassword(email, pwd);
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        // Email å·²è¢«è¨»å†Šï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºç•°å¸¸æƒ…æ³
                        const existingUserDoc = await db.collection('users')
                            .where('email', '==', email)
                            .where('isRegistered', '==', true)
                            .get();

                        if (!existingUserDoc.empty) {
                            throw new Error('æ­¤ Email å·²å®Œæˆé–‹é€šï¼Œè«‹ç›´æ¥å‰å¾€ç™»å…¥é é¢');
                        } else {
                            throw new Error('æ­¤ Email å·²è¢«è¨»å†Šä½†è³‡æ–™ç•°å¸¸ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡å”åŠ©è™•ç†');
                        }
                    } else if (authError.code === 'auth/weak-password') {
                        throw new Error('å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘ 6 å€‹å­—å…ƒçš„å¯†ç¢¼');
                    } else if (authError.code === 'auth/invalid-email') {
                        throw new Error('Email æ ¼å¼ä¸æ­£ç¢º');
                    } else {
                        throw new Error(`Firebase Auth å»ºç«‹å¤±æ•—ï¼š${authError.message}`);
                    }
                }

                const newUid = userCredential.user.uid;
                console.log('[é–‹é€šæµç¨‹] Auth å¸³è™Ÿå»ºç«‹æˆåŠŸï¼ŒUID:', newUid);

                // Step 4: è³‡æ–™é·ç§»ï¼ˆä¿®å¾©ï¼šåŠ å…¥ Firestore å¤±æ•—å›æ»¾æ©Ÿåˆ¶ï¼‰
                console.log('[é–‹é€šæµç¨‹] Step 3: è³‡æ–™é·ç§»è‡³æ­£å¼æ–‡ä»¶...');
                
                try {
                    const batch = db.batch();

                    // å»ºç«‹æ–°æ–‡ä»¶ï¼ˆDocument ID = çœŸå¯¦ UIDï¼‰
                    const newDocRef = db.collection('users').doc(newUid);
                    batch.set(newDocRef, {
                        ...userData,
                        uid: newUid,
                        isRegistered: true,
                        isActive: true,
                        activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // åˆªé™¤èˆŠçš„æš«å­˜æ–‡ä»¶
                    batch.delete(oldDocRef);

                    // åŸ·è¡Œ Batch æ“ä½œ
                    await batch.commit();
                    console.log('[é–‹é€šæµç¨‹] Firestore è³‡æ–™é·ç§»å®Œæˆ');

                } catch (firestoreError) {
                    console.error('[é–‹é€šæµç¨‹] Firestore å¯«å…¥å¤±æ•—ï¼ŒåŸ·è¡Œå›æ»¾...', firestoreError);
                    
                    // === ä¿®å¾©ï¼šå›æ»¾ Firebase Auth å¸³è™Ÿ ===
                    if (userCredential && userCredential.user) {
                        try {
                            await userCredential.user.delete();
                            console.log('[é–‹é€šæµç¨‹] Auth å¸³è™Ÿå·²å›æ»¾åˆªé™¤');
                        } catch (deleteError) {
                            console.error('[é–‹é€šæµç¨‹] Auth å›æ»¾å¤±æ•—:', deleteError);
                        }
                    }

                    throw new Error(`è³‡æ–™åº«å¯«å…¥å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦é–‹é€šã€‚éŒ¯èª¤è©³æƒ…ï¼š${firestoreError.message}`);
                }

                // Step 5: å®Œæˆé–‹é€š
                console.log('[é–‹é€šæµç¨‹] âœ“ é–‹é€šå®Œæˆï¼');
                showSuccess('âœ“ å¸³è™Ÿé–‹é€šæˆåŠŸï¼3 ç§’å¾Œå°‡è‡ªå‹•è·³è½‰è‡³ç™»å…¥é é¢...');
                
                // 3 ç§’å¾Œè·³è½‰
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                // æœ€å¤–å±¤éŒ¯èª¤è™•ç†
                console.error('[é–‹é€šæµç¨‹] ç™¼ç”ŸéŒ¯èª¤:', error);
                throw error;
            }
        }

        // é˜²æ­¢é‡è¤‡æäº¤
        let isSubmitting = false;
        form.addEventListener('submit', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
