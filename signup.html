<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«é™¢æ’ç­ç³»çµ± - å¸³è™Ÿé–‹é€š</title>
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh;">

    <div class="login-card" style="width: 400px; padding: 30px;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">
            <i class="fas fa-user-check"></i> å¸³è™Ÿé–‹é€šèªé ˜
        </h2>
        
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
            è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥è³‡è¨Šä»¥é©—è­‰èº«åˆ†ã€‚é©—è­‰é€šéå¾Œå³å¯è¨­å®šå¯†ç¢¼ã€‚
        </p>

        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">å“¡å·¥ç·¨è™Ÿ</label>
            <input type="text" id="verifyEmpId" placeholder="ä¾‹å¦‚: N1001" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">Email (å¿…é ˆèˆ‡å»ºæª”ä¸€è‡´)</label>
            <input type="email" id="verifyEmail" placeholder="æ‚¨çš„ Email" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">è¨­å®šæ–°å¯†ç¢¼</label>
            <input type="password" id="newPwd" placeholder="è«‹è¨­å®š 6 ä½æ•¸ä»¥ä¸Šå¯†ç¢¼" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
        </div>

        <button class="btn btn-primary" onclick="activateAccount()" id="btnSubmit">
            ç¢ºèªé–‹é€š
        </button>
        
        <p id="msg" style="color: red; margin-top: 15px; text-align: center; font-size: 0.9rem;"></p>

        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <a href="index.html" style="color: #3498db; text-decoration: none;">å·²æœ‰å¸³è™Ÿï¼Ÿç›´æ¥ç™»å…¥</a>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        async function activateAccount() {
            const empId = document.getElementById('verifyEmpId').value.trim();
            const email = document.getElementById('verifyEmail').value.trim();
            const pwd = document.getElementById('newPwd').value;
            const msg = document.getElementById('msg');
            const btn = document.getElementById('btnSubmit');

            if(!empId || !email || !pwd) {
                msg.textContent = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"; return;
            }
            if(pwd.length < 6) {
                msg.textContent = "å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 ç¢¼"; return;
            }

            msg.textContent = "æ­£åœ¨é©—è­‰è³‡æ–™...";
            msg.style.color = "blue";
            btn.disabled = true;

            try {
                // 1. æŸ¥è©¢è³‡æ–™åº«ï¼šæ˜¯å¦æœ‰åå–®ï¼Ÿ
                const snapshot = await db.collection('users')
                    .where('employeeId', '==', empId)
                    .where('email', '==', email)
                    .get();

                if (snapshot.empty) {
                    throw new Error("æ‰¾ä¸åˆ°æ­¤å“¡å·¥è³‡æ–™ï¼Œæˆ– Email/å“¡ç·¨ ä¸ç¬¦ã€‚");
                }

                const oldDoc = snapshot.docs[0];
                const userData = oldDoc.data();

                // 2. æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨»å†Šé
                if (userData.isRegistered && userData.uid) {
                    throw new Error("æ­¤å¸³è™Ÿå·²ç¶“é–‹é€šï¼Œè«‹ç›´æ¥å‰å¾€ç™»å…¥é é¢ã€‚");
                }

                msg.textContent = "é©—è­‰é€šéï¼Œæ­£åœ¨å»ºç«‹å¸³è™Ÿ...";

                // 3. å»ºç«‹ Firebase Auth å¸³è™Ÿ (é€™ä¸€æ­¥æœƒç™»å…¥è©²æ–°å¸³è™Ÿ)
                const userCredential = await auth.createUserWithEmailAndPassword(email, pwd);
                const newUid = userCredential.user.uid;

                // 4. è³‡æ–™é·ç§»ï¼šå»ºç«‹æ–°æ–‡ä»¶ (ID=UID) -> åˆªé™¤èˆŠæ–‡ä»¶
                const batch = db.batch();
                
                // æ–°æ–‡ä»¶åƒç…§
                const newDocRef = db.collection('users').doc(newUid);
                
                // è¤‡è£½èˆŠè³‡æ–™ä¸¦æ›´æ–°ç‹€æ…‹
                const newData = { ...userData };
                delete newData.uid; 
                
                batch.set(newDocRef, {
                    ...newData,
                    uid: newUid,           // ç¶å®šçœŸå¯¦ UID
                    isRegistered: true,    // æ¨™è¨˜å·²è¨»å†Š
                    activatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // åˆªé™¤èˆŠçš„æš«å­˜æ–‡ä»¶
                batch.delete(oldDoc.ref);

                await batch.commit();

                alert("ğŸ‰ é–‹é€šæˆåŠŸï¼\nç³»çµ±å°‡è‡ªå‹•å¼•å°è‡³é¦–é ï¼Œè«‹ä½¿ç”¨å‰›è¨­å®šçš„å¯†ç¢¼ç™»å…¥ã€‚");
                window.location.href = 'index.html';

            } catch (error) {
                console.error(error);
                let text = error.message;
                if(error.code === 'auth/email-already-in-use') text = "æ­¤ Email å·²ç¶“è¢«è¨»å†Šéäº† (Auth)ï¼Œè«‹å˜—è©¦ç›´æ¥ç™»å…¥ã€‚";
                msg.style.color = "red";
                msg.textContent = text;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
