<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«é™¢æ’ç­ç³»çµ± - å¸³è™Ÿé–‹é€š</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;">

    <div class="login-card" style="width: 450px; max-width: 100%; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 10px;">
            <i class="fas fa-user-check"></i> å¸³è™Ÿé–‹é€šèªé ˜
        </h2>
        
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 25px; text-align: center; line-height: 1.6;">
            è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥è³‡è¨Šä»¥é©—è­‰èº«åˆ†<br>
            é©—è­‰é€šéå¾Œå³å¯è¨­å®šå¯†ç¢¼ä¸¦å•Ÿç”¨å¸³è™Ÿ
        </p>

        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold; color:#333;">
                <i class="fas fa-id-badge"></i> å“¡å·¥ç·¨è™Ÿ
            </label>
            <input type="text" id="verifyEmpId" placeholder="ä¾‹å¦‚: N1001" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold; color:#333;">
                <i class="fas fa-envelope"></i> Email (å¿…é ˆèˆ‡å»ºæª”ä¸€è‡´)
            </label>
            <input type="email" id="verifyEmail" placeholder="æ‚¨çš„ Email" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold; color:#333;">
                <i class="fas fa-lock"></i> è¨­å®šæ–°å¯†ç¢¼
            </label>
            <input type="password" id="newPwd" placeholder="è«‹è¨­å®š 6 ä½æ•¸ä»¥ä¸Šå¯†ç¢¼" 
                   style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
            <small style="color:#999; font-size:0.85rem; display:block; margin-top:5px;">
                å¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒï¼Œå»ºè­°åŒ…å«è‹±æ–‡åŠæ•¸å­—
            </small>
        </div>

        <button class="btn btn-primary" onclick="activateAccount()" id="btnSubmit" 
                style="width:100%; padding:12px; font-size:16px; font-weight:bold;">
            <i class="fas fa-check-circle"></i> ç¢ºèªé–‹é€š
        </button>
        
        <div id="msgBox" style="margin-top: 15px; padding: 12px; border-radius: 4px; display:none;">
            <p id="msg" style="margin:0; font-size: 0.9rem; line-height:1.5;"></p>
        </div>

        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <a href="index.html" style="color: #3498db; text-decoration: none; font-weight:500;">
                <i class="fas fa-sign-in-alt"></i> å·²æœ‰å¸³è™Ÿï¼Ÿç›´æ¥ç™»å…¥
            </a>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // é¡¯ç¤ºè¨Šæ¯çš„è¼”åŠ©å‡½æ•¸
        function showMessage(text, type = 'info') {
            const msgBox = document.getElementById('msgBox');
            const msg = document.getElementById('msg');
            msgBox.style.display = 'block';
            msg.innerHTML = text;
            
            switch(type) {
                case 'error':
                    msgBox.style.backgroundColor = '#fee';
                    msgBox.style.borderLeft = '4px solid #e74c3c';
                    msgBox.style.color = '#721c24';
                    break;
                case 'success':
                    msgBox.style.backgroundColor = '#d4edda';
                    msgBox.style.borderLeft = '4px solid #28a745';
                    msgBox.style.color = '#155724';
                    break;
                case 'warning':
                    msgBox.style.backgroundColor = '#fff3cd';
                    msgBox.style.borderLeft = '4px solid #ffc107';
                    msgBox.style.color = '#856404';
                    break;
                default:
                    msgBox.style.backgroundColor = '#d1ecf1';
                    msgBox.style.borderLeft = '4px solid #17a2b8';
                    msgBox.style.color = '#0c5460';
            }
        }

        async function activateAccount() {
            const empId = document.getElementById('verifyEmpId').value.trim();
            const email = document.getElementById('verifyEmail').value.trim();
            const pwd = document.getElementById('newPwd').value;
            const btn = document.getElementById('btnSubmit');

            // åŸºæœ¬é©—è­‰
            if(!empId || !email || !pwd) {
                showMessage('âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }
            if(pwd.length < 6) {
                showMessage('âŒ å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 å€‹å­—å…ƒ', 'error');
                return;
            }

            // é©—è­‰ Email æ ¼å¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if(!emailRegex.test(email)) {
                showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼', 'error');
                return;
            }

            showMessage('â³ æ­£åœ¨è™•ç†...', 'info');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';

            try {
                console.log('[é–‹é€š] é–‹å§‹é–‹é€šæµç¨‹...');
                
                // ========================================
                // æ­¥é©Ÿ 1: æª¢æŸ¥ Email æ˜¯å¦å·²åœ¨ Auth ä¸­è¨»å†Š
                // ========================================
                console.log('[é–‹é€š] æ­¥é©Ÿ 1: æª¢æŸ¥ Email æ˜¯å¦å·²è¨»å†Š...');
                const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                
                if (signInMethods.length > 0) {
                    console.warn('[é–‹é€š] Email å·²åœ¨ Auth ä¸­è¨»å†Š');
                    
                    // é¡¯ç¤ºç‰¹æ®Šçš„éŒ¯èª¤è¨Šæ¯ï¼Œæä¾›ä¿®å¾©é¸é …
                    showMessage(
                        'âš ï¸ æ­¤ Email å·²è¢«è¨»å†Š<br><br>' +
                        '<strong>å¯èƒ½çš„æƒ…æ³ï¼š</strong><br>' +
                        '1. æ‚¨å·²å®Œæˆé–‹é€š â†’ <a href="index.html" style="color:#3498db; font-weight:bold;">ç›´æ¥ç™»å…¥</a><br>' +
                        '2. ä¹‹å‰é–‹é€šå¤±æ•—ï¼Œè³‡æ–™ä¸ä¸€è‡´<br>' +
                        '3. Auth ç³»çµ±ä¸­æœ‰å­¤å…’å¸³è™Ÿ<br><br>' +
                        '<strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>' +
                        '<button onclick="handleExistingAccount(\'' + email + '\', \'' + empId + '\', \'' + pwd + '\')" ' +
                        'style="margin-top:10px; padding:8px 16px; background:#e67e22; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">' +
                        '<i class="fas fa-tools"></i> å˜—è©¦è‡ªå‹•ä¿®å¾©' +
                        '</button><br>' +
                        '<small style="display:block; margin-top:15px; padding:10px; background:#fff3cd; border-radius:4px; border-left:3px solid #ffc107;">' +
                        '<strong style="color:#856404;">ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ</strong><br>' +
                        'è«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ï¼Œæä¾›æ­¤ Email åœ°å€ï¼Œ<br>' +
                        'ç®¡ç†å“¡å¯ä½¿ç”¨ã€Œ<a href="account_diagnosis.html" style="color:#856404; text-decoration:underline;">å¸³è™Ÿè¨ºæ–·å·¥å…·</a>ã€å¿«é€Ÿä¿®å¾©ã€‚' +
                        '</small>',
                        'warning'
                    );
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> ç¢ºèªé–‹é€š';
                    return;
                }

                // ========================================
                // æ­¥é©Ÿ 2: å»ºç«‹ Firebase Auth å¸³è™Ÿ
                // ========================================
                console.log('[é–‹é€š] æ­¥é©Ÿ 2: å»ºç«‹ Auth å¸³è™Ÿ...');
                showMessage('â³ æ­£åœ¨å»ºç«‹å¸³è™Ÿ...', 'info');

                const userCredential = await auth.createUserWithEmailAndPassword(email, pwd);
                const newUid = userCredential.user.uid;
                
                console.log('[é–‹é€š] Auth å¸³è™Ÿå»ºç«‹æˆåŠŸ, UID:', newUid);

                // ========================================
                // æ­¥é©Ÿ 3: é©—è­‰å“¡å·¥è³‡æ–™
                // ========================================
                console.log('[é–‹é€š] æ­¥é©Ÿ 3: é©—è­‰å“¡å·¥è³‡æ–™...');
                showMessage('â³ æ­£åœ¨é©—è­‰å“¡å·¥è³‡æ–™...', 'info');

                await validateAndMigrateData(empId, email, newUid);

                // ========================================
                // æ­¥é©Ÿ 4: å®Œæˆ
                // ========================================
                showMessage(
                    'âœ… é–‹é€šæˆåŠŸï¼<br><br>' +
                    'æ‚¨çš„å¸³è™Ÿå·²æˆåŠŸå•Ÿç”¨ã€‚<br>' +
                    'ç³»çµ±å°‡åœ¨ 3 ç§’å¾Œè‡ªå‹•å°å‘ç™»å…¥é é¢...',
                    'success'
                );

                await auth.signOut();

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error('[é–‹é€š] é–‹é€šå¤±æ•—:', error);
                handleActivationError(error);
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> ç¢ºèªé–‹é€š';
            }
        }

        // è™•ç†å·²å­˜åœ¨å¸³è™Ÿçš„æƒ…æ³
        async function handleExistingAccount(email, empId, pwd) {
            if (!confirm('æ­¤æ“ä½œå°‡å˜—è©¦ä¿®å¾©è³‡æ–™ä¸¦é‡è¨­å¯†ç¢¼ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            showMessage('â³ æ­£åœ¨ä¿®å¾©è³‡æ–™...', 'info');
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;

            try {
                console.log('[ä¿®å¾©] é–‹å§‹ä¿®å¾©æµç¨‹...');
                
                // æ­¥é©Ÿ 1: å˜—è©¦ä½¿ç”¨è‡¨æ™‚å¯†ç¢¼ç™»å…¥
                console.log('[ä¿®å¾©] æ­¥é©Ÿ 1: å˜—è©¦ç™»å…¥...');
                
                let currentUser = null;
                try {
                    // å˜—è©¦ç”¨æ–°å¯†ç¢¼ç™»å…¥
                    const cred = await auth.signInWithEmailAndPassword(email, pwd);
                    currentUser = cred.user;
                    console.log('[ä¿®å¾©] ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥æˆåŠŸ');
                } catch (loginError) {
                    console.log('[ä¿®å¾©] æ–°å¯†ç¢¼ç™»å…¥å¤±æ•—ï¼Œå˜—è©¦ç™¼é€é‡è¨­éƒµä»¶...');
                    
                    // ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶
                    await auth.sendPasswordResetEmail(email);
                    
                    showMessage(
                        'ğŸ“§ å¯†ç¢¼é‡è¨­éƒµä»¶å·²ç™¼é€<br><br>' +
                        'è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾éƒµä»¶å¤¾ï¼‰ã€‚<br>' +
                        'é»æ“Šéƒµä»¶ä¸­çš„é€£çµé‡è¨­å¯†ç¢¼å¾Œï¼Œå³å¯ç™»å…¥ã€‚<br><br>' +
                        '<a href="index.html" style="color:#3498db; font-weight:bold;">å‰å¾€ç™»å…¥é é¢</a>',
                        'success'
                    );
                    
                    btn.disabled = false;
                    return;
                }

                // æ­¥é©Ÿ 2: é©—è­‰ä¸¦ä¿®å¾© Firestore è³‡æ–™
                console.log('[ä¿®å¾©] æ­¥é©Ÿ 2: é©—è­‰ä¸¦ä¿®å¾© Firestore è³‡æ–™...');
                showMessage('â³ æ­£åœ¨ä¿®å¾©è³‡æ–™...', 'info');
                
                await validateAndMigrateData(empId, email, currentUser.uid);

                // æ­¥é©Ÿ 3: å®Œæˆ
                showMessage(
                    'âœ… ä¿®å¾©æˆåŠŸï¼<br><br>' +
                    'æ‚¨çš„å¸³è™Ÿå·²ä¿®å¾©ä¸¦å¯æ­£å¸¸ä½¿ç”¨ã€‚<br>' +
                    'ç³»çµ±å°‡åœ¨ 3 ç§’å¾Œè‡ªå‹•å°å‘ç™»å…¥é é¢...',
                    'success'
                );

                await auth.signOut();

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error('[ä¿®å¾©] ä¿®å¾©å¤±æ•—:', error);
                
                showMessage(
                    'âŒ ä¿®å¾©å¤±æ•—<br><br>' +
                    error.message + '<br><br>' +
                    'è«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨ã€Œæ•…éšœæ’æŸ¥å·¥å…·ã€é€²è¡Œä¿®å¾©ã€‚',
                    'error'
                );
                
                btn.disabled = false;
            }
        }

        // é©—è­‰ä¸¦é·ç§»è³‡æ–™çš„å…±ç”¨å‡½æ•¸
        async function validateAndMigrateData(empId, email, uid) {
            try {
                const userQuery = await db.collection('users')
                    .where('employeeId', '==', empId)
                    .where('email', '==', email)
                    .where('isActive', '==', true)
                    .get();

                if (userQuery.empty) {
                    throw new Error('æ‰¾ä¸åˆ°æ­¤å“¡å·¥è³‡æ–™ï¼Œè«‹ç¢ºèªå“¡å·¥ç·¨è™Ÿå’Œ Email æ˜¯å¦æ­£ç¢ºã€‚');
                }

                if (userQuery.size > 1) {
                    console.warn('[é©—è­‰] è­¦å‘Šï¼šç™¼ç¾å¤šç­†ç›¸åŒçš„å“¡å·¥è¨˜éŒ„');
                    // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œç¹¼çºŒè™•ç†ï¼ˆæœƒè‡ªå‹•æ¸…ç†ï¼‰
                }

                // å–å¾—æ‰€æœ‰åŒ¹é…çš„è¨˜éŒ„
                const allDocs = [];
                userQuery.forEach(doc => {
                    allDocs.push({
                        ref: doc.ref,
                        id: doc.id,
                        data: doc.data()
                    });
                });

                console.log(`[é©—è­‰] æ‰¾åˆ° ${allDocs.length} ç­†å“¡å·¥è³‡æ–™`);

                // æº–å‚™æ–°è³‡æ–™ï¼ˆä½¿ç”¨ç¬¬ä¸€ç­†è¨˜éŒ„çš„è³‡æ–™ï¼‰
                const baseData = allDocs[0].data;
                
                // è¨˜éŒ„åŸå§‹è³‡æ–™ä»¥ä¾›é™¤éŒ¯
                console.log('[é·ç§»] åŸå§‹è³‡æ–™:', baseData);
                
                // ç¢ºä¿ä¿ç•™æ‰€æœ‰åŸå§‹æ¬„ä½
                const newData = {
                    ...baseData,  // ä¿ç•™æ‰€æœ‰åŸå§‹æ¬„ä½
                    uid: uid,
                    isRegistered: true,
                    isActive: true,
                    activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ç¢ºèªé—œéµæ¬„ä½å­˜åœ¨
                console.log('[é·ç§»] æ–°è³‡æ–™:', {
                    employeeId: newData.employeeId,
                    displayName: newData.displayName,
                    email: newData.email,
                    unitId: newData.unitId,
                    role: newData.role,
                    level: newData.level,
                    uid: newData.uid,
                    isRegistered: newData.isRegistered,
                    totalFields: Object.keys(newData).length
                });

                // ä½¿ç”¨ Batch æ“ä½œ
                const batch = db.batch();
                
                // å»ºç«‹æ–°æ–‡ä»¶ï¼ˆID = UIDï¼‰
                const newDocRef = db.collection('users').doc(uid);
                batch.set(newDocRef, newData);
                console.log('[é·ç§»] å»ºç«‹æ–°æ–‡ä»¶:', uid);
                console.log('[é·ç§»] åŒ…å«æ¬„ä½:', Object.keys(newData).join(', '));
                
                // åˆªé™¤æ‰€æœ‰èˆŠçš„æ–‡ä»¶
                allDocs.forEach(doc => {
                    if (doc.id !== uid) {
                        batch.delete(doc.ref);
                        console.log('[é·ç§»] åˆªé™¤èˆŠæ–‡ä»¶:', doc.id);
                    }
                });

                await batch.commit();
                console.log('[é·ç§»] Firestore è³‡æ–™é·ç§»æˆåŠŸ');
                
                // é©—è­‰æ–°æ–‡ä»¶
                const verifyDoc = await db.collection('users').doc(uid).get();
                if (verifyDoc.exists) {
                    const verifyData = verifyDoc.data();
                    console.log('[é©—è­‰] æ–°æ–‡ä»¶è³‡æ–™ç¢ºèª:', {
                        employeeId: verifyData.employeeId,
                        displayName: verifyData.displayName,
                        unitId: verifyData.unitId,
                        role: verifyData.role,
                        level: verifyData.level
                    });
                } else {
                    console.error('[é©—è­‰] è­¦å‘Šï¼šæ–°æ–‡ä»¶ä¸å­˜åœ¨ï¼');
                }

            } catch (error) {
                console.error('[é©—è­‰] å¤±æ•—:', error);
                
                // é©—è­‰å¤±æ•—ï¼Œæ¸…ç† Auth å¸³è™Ÿ
                try {
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.uid === uid) {
                        await currentUser.delete();
                        console.log('[æ¸…ç†] å·²æ¸…ç†å¤±æ•—çš„ Auth å¸³è™Ÿ');
                    }
                } catch (deleteError) {
                    console.error('[æ¸…ç†] æ¸…ç† Auth å¸³è™Ÿå¤±æ•—:', deleteError);
                }
                
                throw error;
            }
        }

        // éŒ¯èª¤è™•ç†
        function handleActivationError(error) {
            let errorMessage = error.message;
            
            if (error.code) {
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'æ­¤ Email å·²è¢«è¨»å†Šã€‚\n\nè«‹é»æ“Šä¸Šæ–¹çš„ã€Œå˜—è©¦ä¿®å¾©ä¸¦é–‹é€šã€æŒ‰éˆ•ã€‚';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘ 6 å€‹å­—å…ƒçš„å¯†ç¢¼ã€‚';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚';
                        break;
                    case 'permission-denied':
                        errorMessage = 'æ¬Šé™ä¸è¶³ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. å®‰å…¨è¦å‰‡è¨­å®šå•é¡Œ\n2. è³‡æ–™ç‹€æ…‹ç•°å¸¸\n\nè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚';
                        break;
                }
            }
            
            showMessage('âŒ é–‹é€šå¤±æ•—<br><br>' + errorMessage.replace(/\n/g, '<br>'), 'error');
        }

        // æŒ‰ Enter éµæäº¤
        document.addEventListener('DOMContentLoaded', () => {
            ['verifyEmpId', 'verifyEmail', 'newPwd'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') activateAccount();
                    });
                }
            });
        });
    </script>
</body>
</html>
