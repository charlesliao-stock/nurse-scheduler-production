<div class="page-section active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;"><i class="fas fa-calendar-alt"></i> 預班管理</h2>
    </div>
    
    <div class="toolbar">
        <label style="margin-right:10px; font-weight:bold;">選擇單位：</label>
        <select id="filterPreUnit" style="padding:8px; border-radius:4px; border:1px solid #ccc; width: 200px;">
            <option value="">載入中...</option>
        </select>
        
        <div style="margin-left:auto;">
            <button id="btnAddPreSchedule" class="btn btn-add" onclick="preScheduleManager.openModal()">
                <i class="fas fa-plus"></i> 新增預班表
            </button>
        </div>
    </div>

    <div class="table-container">
        <table id="preScheduleTable">
            <thead>
                <tr>
                    <th style="width: 15%;">預班月份</th>
                    <th style="width: 25%;">開放區間</th>
                    <th style="width: 20%;">預班進度 (已交/總數)</th>
                    <th style="width: 15%;">狀態</th>
                    <th style="width: 25%;">操作</th>
                </tr>
            </thead>
            <tbody id="preScheduleTableBody"></tbody>
        </table>
    </div>
</div>

<div id="preScheduleModal" class="modal">
    <div class="modal-content" style="max-width: 1400px; width: 92vw; height: 88vh; display: flex; flex-direction: column; padding: 0;">
        
        <div style="padding: 20px 25px 0 25px; display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee;">
            <h3 style="margin:0; border:none; color:#2c3e50;">
                <i class="fas fa-calendar-alt"></i> 預班表設定
            </h3>
            <button class="btn btn-import" id="btnImportLast" onclick="preScheduleManager.importLastSettings()" style="font-size:0.9rem; padding:6px 12px;">
                <i class="fas fa-history"></i> 帶入上月設定
            </button>
        </div>
        
        <input type="hidden" id="preScheduleDocId">
        <input type="hidden" id="currentMode">

        <div class="tab-header" style="padding: 0 25px; margin-top: 0; background: #f8f9fa;">
            <button class="tab-btn active" onclick="preScheduleManager.switchTab('basic')">
                <i class="fas fa-cog"></i> 基本設定
            </button>
            <button class="tab-btn" onclick="preScheduleManager.switchTab('limits')">
                <i class="fas fa-users"></i> 組別限制
            </button>
            <button class="tab-btn" onclick="preScheduleManager.switchTab('staff')">
                <i class="fas fa-user-check"></i> 參與人員 
                <span id="staffTotalCount" class="badge" style="background:#3498db; margin-left:5px; font-weight:bold;">0</span>
            </button>
        </div>

        <div class="tab-content-wrapper" style="flex: 1; overflow-y: auto; padding: 25px 30px; background: #fafbfc;">
            
            <!-- Tab 1: 基本設定 -->
            <div id="tab-basic" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    
                    <!-- 左欄 -->
                    <div>
                        <h4 style="color:#2c3e50; border-left:4px solid #3498db; padding-left:12px; margin-top:0; margin-bottom:20px;">
                            <i class="fas fa-calendar-check"></i> 預班時程
                        </h4>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label><i class="fas fa-calendar"></i> 預班月份 *</label>
                            <input type="month" id="inputPreYearMonth" style="font-weight:bold; font-size: 1.05rem;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label><i class="fas fa-door-open"></i> 開放日期 *</label>
                                <input type="date" id="inputOpenDate">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-door-closed"></i> 截止日期 *</label>
                                <input type="date" id="inputCloseDate">
                            </div>
                        </div>

                        <div class="form-group" style="background: #e8f6f3; padding: 15px; border-radius: 6px; border-left: 4px solid #16a085;">
                            <label style="cursor:pointer; display:flex; align-items:center; margin:0;">
                                <input type="checkbox" id="checkShowAllNames" style="width:auto; margin-right:10px;">
                                <span><i class="fas fa-eye"></i> 顯示所有預班者姓名 (公開透明)</span>
                            </label>
                            <small style="color:#555; margin-top:8px; display:block; margin-left:28px;">
                                啟用後，所有人都能看到誰預休了哪些日期
                            </small>
                        </div>
                    </div>

                    <!-- 右欄 -->
                    <div>
                        <h4 style="color:#2c3e50; border-left:4px solid #e67e22; padding-left:12px; margin-top:0; margin-bottom:20px;">
                            <i class="fas fa-sliders-h"></i> 預班規則
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label><i class="fas fa-hand-paper"></i> 預休上限</label>
                                <input type="number" id="inputMaxOff" placeholder="例如: 8" min="0" max="31">
                                <small>含假日，單位：天</small>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-umbrella-beach"></i> 假日上限</label>
                                <input type="number" id="inputMaxHoliday" placeholder="例如: 2" min="0" max="10">
                                <small>週末與國定假日</small>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-shield-alt"></i> 保留名額</label>
                                <input type="number" id="inputDailyReserve" placeholder="例如: 2" min="0" max="10">
                                <small>每日保留人數</small>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 15px;">
                            <label><i class="fas fa-moon"></i> 排班夜班模式</label>
                            <select id="inputShiftMode" onchange="preScheduleManager.toggleThreeShiftOption()" style="font-size: 1rem;">
                                <option value="2">2種班別 (白班/夜班 - 固定班)</option>
                                <option value="3">3種班別 (白班/小夜/大夜 - 花班)</option>
                            </select>
                        </div>

                        <div class="form-group" id="divAllowThree" style="display:none; background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #f39c12;">
                            <label style="cursor:pointer; display:flex; align-items:center; margin:0;">
                                <input type="checkbox" id="checkAllowThree" style="width:auto; margin-right:10px;"> 
                                <span><i class="fas fa-check-circle"></i> 同意同仁自願選擇 3 種班</span>
                            </label>
                            <small style="color:#856404; margin-top:8px; display:block; margin-left:28px;">
                                勾選後將允許護理師自行勾選是否願意上三班制
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 組別限制 -->
            <div id="tab-limits" class="tab-content">
                <h4 style="color:#2c3e50; border-left:4px solid #9b59b6; padding-left:12px; margin-top:0; margin-bottom:20px;">
                    <i class="fas fa-users-cog"></i> 各組別每日人力限制設定
                </h4>
                
                <div class="alert-box" style="background:#e8f6f3; color:#0e6251; padding:12px 15px; border-radius:6px; margin-bottom:20px; border-left: 4px solid #16a085;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>使用說明：</strong>請輸入各組別每日的人力限制。若該項不限制，請留空 (預設為不限)。
                </div>
                
                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <table class="matrix-table sticky-th" id="groupLimitTable" style="min-width: 100%;"></table>
                </div>
            </div>

            <!-- Tab 3: 參與人員 -->
            <div id="tab-staff" class="tab-content">
                <h4 style="color:#2c3e50; border-left:4px solid #27ae60; padding-left:12px; margin-top:0; margin-bottom:20px;">
                    <i class="fas fa-user-friends"></i> 本次預班參與人員名單
                </h4>
                
                <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <label style="font-weight: bold; color: #555; margin-bottom: 10px; display: block;">
                        <i class="fas fa-search"></i> 搜尋並新增支援人員
                    </label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="inputSearchStaff" 
                               placeholder="輸入員編或姓名後，按 Enter 搜尋..." 
                               onkeyup="preScheduleManager.handleSearchEnter(event)"
                               style="flex:1; padding:10px 15px; border:1px solid #ccc; border-radius:6px; font-size: 0.95rem;">
                        <button class="btn btn-add" onclick="preScheduleManager.searchStaff()" style="padding: 10px 25px;">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>
                    <div id="searchResults" style="margin-top: 15px;"></div>
                </div>

                <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <table style="width:100%;">
                        <thead class="sticky-th" style="background: #f1f3f5;">
                            <tr>
                                <th style="width:15%; cursor:pointer;" onclick="preScheduleManager.sortStaff('empId')">
                                    <i class="fas fa-id-card"></i> 員編 <i id="sort_icon_pre_empId" class="fas fa-sort"></i>
                                </th>
                                <th style="width:20%; cursor:pointer;" onclick="preScheduleManager.sortStaff('name')">
                                    <i class="fas fa-user"></i> 姓名 <i id="sort_icon_pre_name" class="fas fa-sort"></i>
                                </th>
                                <th style="width:12%; cursor:pointer;" onclick="preScheduleManager.sortStaff('level')">
                                    <i class="fas fa-layer-group"></i> 層級 <i id="sort_icon_pre_level" class="fas fa-sort"></i>
                                </th>
                                <th style="width:18%; cursor:pointer;" onclick="preScheduleManager.sortStaff('group')">
                                    <i class="fas fa-users"></i> 組別 <i id="sort_icon_pre_group" class="fas fa-sort"></i>
                                </th>
                                <th style="width:20%; cursor:pointer;" onclick="preScheduleManager.sortStaff('isSupport')">
                                    <i class="fas fa-tag"></i> 身份 <i id="sort_icon_pre_isSupport" class="fas fa-sort"></i>
                                </th>
                                <th style="width:15%; text-align: center;">
                                    <i class="fas fa-cog"></i> 操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="preStaffBody"></tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <div style="text-align:right; padding: 18px 30px; border-top:2px solid #e9ecef; background: #f8f9fa;">
            <button class="btn btn-close" onclick="preScheduleManager.closeModal()" style="padding: 10px 20px;">
                <i class="fas fa-times"></i> 取消
            </button>
            <button class="btn btn-add" onclick="preScheduleManager.saveData()" style="padding: 10px 25px; font-size: 1rem;">
                <i class="fas fa-save"></i> 儲存設定
            </button>
        </div>
    </div>
</div>
