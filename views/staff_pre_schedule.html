<div class="page-section active" style="padding:0; height:100vh; display:flex; flex-direction:column;">
    
    <div style="padding:15px 20px; background:white; border-bottom:1px solid #ddd; display:flex; align-items:center; justify-content:space-between; flex-shrink:0;">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn" onclick="history.back()" style="background:#95a5a6;">
                <i class="fas fa-arrow-left"></i> 返回列表
            </button>
            <h3 style="margin:0;" id="staffPreTitle">載入中...</h3>
            <span id="staffPreStatus" class="badge"></span>
        </div>
        <div>
            <button class="btn btn-add" id="btnStaffSave" onclick="staffPreScheduleManager.saveRequest()">
                <i class="fas fa-save"></i> 提交預班
            </button>
        </div>
    </div>

    <div style="flex:1; overflow:hidden; display:flex; background:#f4f6f8;">
        
        <div style="flex:1; padding:20px; overflow-y:auto;" id="calendarContainer">
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div style="width:340px; background:white; border-left:1px solid #ddd; padding:20px; display:flex; flex-direction:column; overflow-y:auto;">
            
            <h4 style="margin-top:0; border-bottom:2px solid #3498db; padding-bottom:10px; color:#2c3e50;">
                <i class="fas fa-user-clock"></i> 我的預班統計
            </h4>

            <div id="specialStatusArea" style="margin-bottom:15px; display:none;">
                <span class="badge" style="background:#e67e22; margin-right:5px;" id="badgePregnant">懷孕中</span>
                <span class="badge" style="background:#d35400;" id="badgeBreastfeeding">哺乳中</span>
            </div>

            <div class="stat-card" style="background:#eaf2f8; padding:15px; border-radius:8px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>總預休天數:</span>
                    <span style="font-weight:bold;"><span id="statOffCount">0</span> / <span id="limitMaxOff">-</span></span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>假日預休:</span>
                    <span style="font-weight:bold;"><span id="statHolidayOffCount">0</span> / <span id="limitMaxHoliday">-</span></span>
                </div>
            </div>

            <h4 style="border-bottom:2px solid #e67e22; padding-bottom:10px; color:#2c3e50;">
                <i class="fas fa-sliders-h"></i> 排班偏好
            </h4>

            <div class="form-group" id="bundleGroup" style="margin-bottom:20px; display:none;">
                <label style="font-weight:bold;">包班意願</label>
                <select id="inputBundleShift" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; margin-top:5px;">
                    <option value="">無 (不包班)</option>
                </select>
                <small style="color:#7f8c8d;">僅列出開放包班的項目</small>
            </div>

            <div class="form-group" id="prefGroup" style="margin-bottom:20px;">
                <label style="font-weight:bold;">班別志願序 (夜班偏好)</label>
                <div id="prefContainer" style="margin-top:5px; display:flex; flex-direction:column; gap:8px;">
                    <div style="color:#999; font-size:0.9rem;">載入中...</div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee; color:#7f8c8d; font-size:0.9rem;">
                <p><i class="fas fa-info-circle"></i> 說明:</p>
                <ul style="padding-left:20px; margin:0;">
                    <li><b>左鍵點擊</b>:切換預休 (綠色)。</li>
                    <li><b>右鍵點擊</b>:開啟選單 (指定班別/清除)。</li>
                    <li><span style="color:#e67e22; font-weight:bold;">橘框</span>:名額充足。</li>
                    <li><span style="color:#e74c3c; font-weight:bold;">紅框</span>:名額已滿。</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- [關鍵修正] 確保選單容器結構正確 -->
<div id="staffContextMenu" class="context-menu" style="display:none;">
    <div class="menu-header" id="staffMenuTitle">設定班別</div>
    <div id="staffMenuOptions"></div>
</div>

<style>
/* 日曆樣式 */
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; max-width: 1200px; margin: 0 auto; }
.calendar-header { text-align: center; font-weight: bold; padding: 10px; background: #e0e0e0; border-radius: 4px; }
.calendar-day { background: white; border: 1px solid #ccc; border-radius: 6px; min-height: 100px; position: relative; padding: 10px; transition: all 0.2s; cursor: pointer; user-select: none; }
.calendar-day:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); border-color: #3498db; }
.calendar-day.disabled { background: #f9f9f9; color: #bbb; cursor: not-allowed; border-color: #eee; }
.calendar-day.disabled:hover { transform: none; box-shadow: none; }

/* 狀態樣式 */
.calendar-day.selected { background: #d5f5e3; border: 2px solid #2ecc71; }
.calendar-day.selected.warn-orange { border: 2px solid #f39c12; background: #ffe8cc; }
.calendar-day.selected.warn-red { border: 2px solid #e74c3c; background: #fdd7d7; }

/* 改進 2: 預班日歷框顏色 */
.calendar-day.quota-available { background: #e8f8f5; border: 2px solid #27ae60; }
.calendar-day.quota-full { background: #fadbd8; border: 2px solid #e74c3c; }

/* 個人預班：淺橘底 + 橘框 */
.calendar-day.my-selection { background: #ffe8cc; border: 2px solid #f39c12; }

.day-number { font-size: 1.2rem; font-weight: bold; color: #555; }
.day-number.holiday { color: #e74c3c; }

.day-slots { position: absolute; bottom: 5px; right: 8px; font-size: 0.85rem; font-weight: bold; color: #7f8c8d; background: rgba(255,255,255,0.9); padding: 2px 5px; border-radius: 4px; display:flex; align-items:center; gap:3px;}
.day-slots.full { color: #e74c3c; }

.my-status { position: absolute; top: 10px; right: 10px; color: #2ecc71; font-size: 1.2rem; display: none; }
.calendar-day.selected .my-status { display: block; }
.is-weekend { background-color: #fff5f5; }

/* 班別標籤 (顯示在預休位置) */
.shift-tag {
    font-weight: bold; font-size: 1.4rem; color: #3498db;
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
}

/* 確保右鍵選單不被文字選取干擾 */
.calendar-day,
.calendar-day * {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
</style>
