<div class="page-section active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;"><i class="fas fa-cogs"></i> 排班規則設定</h2>
    </div>
    
    <div class="toolbar" style="background:#fff; padding:15px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px;">
        <label style="margin-right:10px; font-weight:bold;">設定單位：</label>
        <select id="ruleUnitSelect" style="padding:8px; border-radius:4px; border:1px solid #ccc; width: 250px;">
            <option value="">載入中...</option>
        </select>
        <button class="btn btn-add" onclick="scheduleRuleManager.saveData()" style="margin-left:auto;">
            <i class="fas fa-save"></i> 儲存規則
        </button>
    </div>

    <div id="rulesContainer" style="display:none; background:#fff; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.05); min-height:600px;">
        
        <div class="tab-header" style="padding: 15px 20px 0 20px; border-bottom:1px solid #ddd;">
            <button class="tab-btn active" onclick="scheduleRuleManager.switchTab('hard')" style="border-top: 3px solid #e74c3c;">1. 法規硬限制</button>
            <button class="tab-btn" onclick="scheduleRuleManager.switchTab('policy')" style="border-top: 3px solid #3498db;">2. 單位規範</button>
            <button class="tab-btn" onclick="scheduleRuleManager.switchTab('pattern')" style="border-top: 3px solid #f1c40f;">3. 輪替邏輯</button>
            <button class="tab-btn" onclick="scheduleRuleManager.switchTab('fairness')" style="border-top: 3px solid #2ecc71;">4. 公平性</button>
            <button class="tab-btn" onclick="scheduleRuleManager.switchTab('ai')" style="border-top: 3px solid #8e44ad;">5. AI 權重</button>
        </div>

        <div class="tab-content-wrapper" style="padding: 20px;">
            
            <div id="tab-hard" class="tab-content active">
                <h4 style="color:#e74c3c; margin-top:0;">法規硬限制 (違反視為非法)</h4>
                <div class="rule-card">
                    <label><input type="checkbox" id="rule_minGap11" checked> 1. 工時與休息：班與班間隔超過 11 小時 (勞基法)</label>
                </div>
                <div class="rule-card">
                    <label><input type="checkbox" id="rule_maxDiversity3" checked> 2. 班別多樣性：一週內不得有 3 種班別</label>
                </div>
                <div class="rule-card">
                    <label><input type="checkbox" id="rule_protectPregnant" checked> 3. 特定身份：懷孕/哺乳期間保護 (自動排除 22-06 勤務)</label>
                </div>
                <div class="rule-card">
                    <label><input type="checkbox" id="rule_twoOffPerFortnight" checked> 4. 休假強制性：2 週內需有 2 個 OFF</label>
                    <div class="rule-detail">OFF 間隔不得大於 <input type="number" id="rule_offGapMax" value="12" style="width:60px;"> 天</div>
                </div>
                <div class="rule-card">
                    <label>5. 週期定義：一週的第一天為</label>
                    <select id="rule_weekStartDay" style="margin-left:10px; padding:4px;">
                        <option value="1">週一</option>
                        <option value="0">週日</option>
                    </select>
                </div>
            </div>

            <div id="tab-policy" class="tab-content">
                <h4 style="color:#3498db; margin-top:0;">單位運作規範</h4>
                
                <div class="rule-card">
                    <label>1. 預班承諾 (權重)</label>
                    <div class="rule-detail" style="display:flex; gap:20px; align-items:center;">
                        <div>
                            預休 (REQ_OFF): 
                            <select id="rule_reqOffWeight">
                                <option value="must">必定滿足</option>
                                <option value="high">部分滿足 (盡量)</option>
                            </select>
                        </div>
                        <div>
                            勿排 (!X): 
                            <select id="rule_reqBanWeight">
                                <option value="must">必定滿足</option>
                                <option value="high">部分滿足 (盡量)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_limitConsecutive" checked> 2. 連續上班限制</label>
                    <div class="rule-detail">一般上限 <input type="number" id="rule_maxConsDays" value="6" style="width:50px;"> 天</div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_longLeaveAdjust" checked> 3. 長假前後調整</label>
                    <div class="rule-detail">
                        預休達 <input type="number" id="rule_longLeaveThres" value="5" style="width:50px;"> 天視為長假，
                        該月允許連上 <input type="number" id="rule_longLeaveMaxCons" value="7" style="width:50px;"> 天。
                    </div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_bundleNightOnly" checked> 4. 包班人員規範：鎖定單一夜班</label>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_noNightAfterOff" checked> 5. 非包班人員規範：OFF 後隔天班別限制</label>
                    <div class="rule-detail">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <span>定義夜班區間：</span>
                            <input type="time" id="rule_nightStart" value="22:00" style="padding:4px;">
                            <span>至</span>
                            <input type="time" id="rule_nightEnd" value="06:00" style="padding:4px;">
                            <span style="color:#666; font-size:0.85rem; margin-left:10px;">(在此區間內起始的班別將受限)</span>
                        </div>
                        <div id="noNightAfterOff_container" style="display:flex; gap:15px; flex-wrap: wrap; background:#f9f9f9; padding:10px; border-radius:4px;">
                            <span style="color:#999;">載入班別中...</span>
                        </div>
                    </div>
                </div>

                <div class="rule-card" style="background:#fff9e6; border-left:4px solid #f1c40f;">
                    <label><input type="checkbox" id="rule_enableRelaxation"> 6. 規則放寬機制 (救火模式)</label>
                    <div class="rule-detail">
                        當人力需求無法滿足時，允許 AI 自動放寬「建議性規則」(如 OFF 後不排夜班、班別多樣性) 以填補缺口。
                        <br><span style="color:#e67e22; font-size:0.85rem;"><i class="fas fa-exclamation-triangle"></i> 關閉時，若規則衝突將產生人力缺口，需由人工手動調整。</span>
                    </div>
                </div>

                <div class="rule-card">
                    <label>6. 新進人員保護</label>
                    <div class="rule-detail">
                        <div><label><input type="checkbox" id="rule_newbie_noNight3m"> 到職 3 個月內不排夜班 (E/N)</label></div>
                        <div><label><input type="checkbox" id="rule_newbie_noBigNight1m"> 到職 1 個月內不排大夜 (N)</label></div>
                        <div><label><input type="checkbox" id="rule_newbie_noSolo1m"> 到職 1 個月內不排單獨上班</label></div>
                    </div>
                </div>
            </div>

            <div id="tab-pattern" class="tab-content">
                <h4 style="color:#f1c40f; margin-top:0;">班別銜接邏輯</h4>
                
                <div class="rule-card">
                    <label>1. 每日起始定義</label>
                    <select id="rule_dayStartShift" style="margin-left:10px;">
                        <option value="D">白班 (00:00大夜算前一日)</option>
                        <option value="N">大夜 (00:00大夜算當日第一班)</option>
                    </select>
                </div>

                <div class="rule-card">
                    <label style="margin-bottom:10px; display:block;">2. 正向輪替規則 (請拖曳方塊調整順序)</label>
                    <div class="rule-detail">
                        <div id="rotationContainer" class="rotation-wrapper">
                            <div style="color:#999;">載入中...</div>
                        </div>
                        <div style="margin-top:10px; color:#666; font-size:0.85rem;">
                            <i class="fas fa-info-circle"></i> 系統將優先依照此順序安排換班 (由左至右)。
                        </div>
                    </div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_consecutivePref" checked> 3. 班別連續性</label>
                    <div class="rule-detail">同種班別盡量連續 <input type="number" id="rule_minConsecutive" value="2" style="width:50px;"> 天</div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_avoidLonelyOff" checked> 4. 孤兒假避免 (盡量連休2天)</label>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_monthBuffer" checked> 5. 接上月班 (月初緩衝)</label>
                    <div class="rule-detail">月初 <input type="number" id="rule_monthBufferDays" value="7" style="width:50px;"> 天內延續上月夜班種類</div>
                </div>
            </div>

            <div id="tab-fairness" class="tab-content">
                <h4 style="color:#2ecc71; margin-top:0;">公平性與技能</h4>
                
                <div class="rule-card">
                    <label><input type="checkbox" id="rule_fairOff" checked> 1. 總放假天數平均化</label>
                    <div class="rule-detail">
                        差異不超過 <input type="number" id="rule_fairOffVar" value="2" style="width:50px;"> 天。
                        <label style="margin-left:15px; color:#d35400;">
                            <input type="checkbox" id="rule_fairOffExcludeLong" checked> 排除長假 > <input type="number" value="6" style="width:40px;" id="rule_fairOffExcludeDays"> 天者
                        </label>
                    </div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_fairHoliday" checked> 2. 假日放假次數平均化</label>
                    <div class="rule-detail">
                        差異不超過 <input type="number" id="rule_fairHolidayVar" value="2" style="width:50px;"> 次。
                        <label style="margin-left:15px;">
                            <input type="checkbox" id="rule_fairHolidayIncNational" checked> 包含國定假日
                        </label>
                    </div>
                </div>

                <div class="rule-card">
                    <label><input type="checkbox" id="rule_fairNight" checked> 3. 夜班總數平均化</label>
                    <div class="rule-detail">差異不超過 <input type="number" id="rule_fairNightVar" value="2" style="width:50px;"> 天 (分包班/非包班計算)</div>
                </div>

                <!-- [新增] 後處理輪數設定 -->
                <div class="rule-card" style="background:#f0f8ff; border-left:4px solid #2ecc71;">
                    <label style="display:block; margin-bottom:10px; color:#2ecc71; font-weight:bold;">
                        <i class="fas fa-sync-alt"></i> 4. 後處理平衡強度
                    </label>
                    <div class="rule-detail">
                        <div style="margin-bottom:10px;">
                            後處理輪數: <input type="number" id="rule_fairBalanceRounds" value="100" style="width:70px;" min="50" max="500" step="10"> 輪
                            <span style="color:#666; font-size:0.85rem; margin-left:10px;">(預設100輪，增加可提升平衡度但耗時較長)</span>
                        </div>
                        <div style="font-size:0.85rem; color:#555; background:#fff; padding:10px; border-radius:4px; margin-top:10px;">
                            <strong>說明：</strong>
                            <ul style="margin:5px 0; padding-left:20px;">
                                <li>系統會在排班完成後，執行多輪交換來平衡放假天數</li>
                                <li>輪數越高，放假天數越平均，但排班時間會增加</li>
                                <li>建議範圍：50~200 輪</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-ai" class="tab-content">
                <h4 style="color:#8e44ad; margin-top:0;">AI 運算參數微調</h4>
                <div class="alert-box" style="background:#f4ecf7; color:#8e44ad; padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9rem;">
                    <i class="fas fa-info-circle"></i> 調整此處數值可改變 AI 排班的優先順序。數值越高代表越優先考量。
                </div>

                <div class="rule-card">
                    <label>1. 決策權重 (分數越高越重要)</label>
                    <div class="rule-detail">
                        <div style="margin-bottom:10px; display:flex; align-items:center;">
                            <span style="width:120px;">⚖️ 平衡積分:</span>
                            <input type="number" id="ai_w_balance" value="200" style="width:70px; margin-right:10px;">
                            <span style="color:#666; font-size:0.85rem;">(劫富濟貧的力度，越高越平均)</span>
                        </div>
                        <div style="margin-bottom:10px; display:flex; align-items:center;">
                            <span style="width:120px;">🔗 連續上班:</span>
                            <input type="number" id="ai_w_continuity" value="50" style="width:70px; margin-right:10px;">
                            <span style="color:#666; font-size:0.85rem;">(同班別延續的力度，越高越少跳班)</span>
                        </div>
                        <div style="margin-bottom:10px; display:flex; align-items:center;">
                            <span style="width:120px;">🔄 支援調度:</span>
                            <input type="number" id="ai_w_surplus" value="150" style="width:70px; margin-right:10px;">
                            <span style="color:#666; font-size:0.85rem;">(從人力過剩班調人的意願)</span>
                        </div>
                    </div>
                </div>

                <div class="rule-card">
                    <label>2. 運算限制 (影響速度與解題能力)</label>
                    <div class="rule-detail">
                        <div style="margin-bottom:10px;">
                            回溯深度: <input type="number" id="ai_backtrack_depth" value="3" style="width:60px;"> 天
                            <span style="color:#666; font-size:0.85rem; margin-left:10px;">(遇到死局時往回修改的天數)</span>
                        </div>
                        <div>
                            單格嘗試次數: <input type="number" id="ai_max_attempts" value="20" style="width:60px;"> 次
                            <span style="color:#666; font-size:0.85rem; margin-left:10px;">(防止系統空轉)</span>
                        </div>
                    </div>
                </div>

                <!-- [關鍵修正] 移除寫死的容忍度，改用公平性頁籤的設定 -->
                <div class="rule-card" style="background:#fff3cd; border-left:4px solid #f39c12;">
                    <label style="display:block; margin-bottom:10px;">
                        <i class="fas fa-info-circle"></i> 容忍度設定
                    </label>
                    <div style="font-size:0.9rem; color:#856404;">
                        <strong>放假天數容忍度</strong>已移至「4. 公平性」頁籤設定。<br>
                        系統會自動使用「總放假天數平均化」中設定的差異值 (預設 2 天)。
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
