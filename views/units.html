<style>
    /* 頁籤樣式 */
    .tab-header {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: bold;
        color: #666;
        border-bottom: 3px solid transparent;
        font-size: 1rem;
    }
    .tab-btn.active {
        color: #3498db;
        border-bottom: 3px solid #3498db;
    }
    .tab-content {
        display: none;
        height: 100%; /* 確保內容撐滿 */
    }
    .tab-content.active {
        display: block;
    }

    /* --- [關鍵修正] Checkbox 列表樣式 (強制靠左) --- */
    .user-checkbox-item {
        width: 100%;
        border-bottom: 1px dashed #eee;
    }
    .user-checkbox-item label {
        display: flex;
        align-items: center;      /* 垂直置中 */
        justify-content: flex-start; /* 水平靠左 */
        width: 100%;
        padding: 8px 5px;
        cursor: pointer;
        margin: 0;
        text-align: left;         /* 文字靠左 */
    }
    .user-checkbox-item input[type="checkbox"] {
        margin-right: 12px;       /* 勾選框與文字的距離 */
        transform: scale(1.2);    /* 放大勾選框 */
        flex-shrink: 0;           /* 防止被壓縮 */
    }
    .u-name {
        font-weight: bold;
        color: #333;
        margin-right: 5px;
    }
    .u-emp-id {
        color: #888;
        font-size: 0.85rem;
    }

    /* 組別管理佈局 */
    .group-manage-container {
        display: flex;
        gap: 20px;
        height: 100%; /* 撐滿父容器 */
        min-height: 350px;
    }
    .group-left-panel {
        flex: 1;
        border-right: 1px solid #eee;
        padding-right: 15px;
        display: flex;
        flex-direction: column;
    }
    .group-right-panel {
        flex: 2;
        display: flex;
        flex-direction: column;
    }
    .group-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: #f9f9f9;
        margin-bottom: 5px;
        border-radius: 4px;
        border: 1px solid #eee;
    }
    .scrollable-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 5px;
        background: #fff;
    }
</style>

<div class="page-section active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;"><i class="fas fa-hospital-alt"></i> 單位管理</h2>
    </div>
    
    <div class="toolbar">
        <input type="text" id="searchUnitInput" placeholder="搜尋單位代碼或名稱..." style="padding:8px; border:1px solid #ccc; border-radius:4px; width:250px;">
        
        <div style="margin-left:auto;">
            <button id="btnAddUnit" class="btn btn-add" onclick="unitManager.openModal()"><i class="fas fa-plus"></i> 新增單位</button>
            <button id="btnImportUnit" class="btn btn-import" onclick="unitManager.openImportModal()"><i class="fas fa-file-import"></i> 批次匯入</button>
        </div>
    </div>

    <div class="table-container">
        <table id="unitTable">
            <thead>
                <tr>
                    <th style="width: 15%;">單位代碼</th>
                    <th style="width: 20%;">單位名稱</th>
                    <th style="width: 25%;">單位管理者</th>
                    <th style="width: 25%;">排班者</th>
                    <th style="width: 15%;">操作</th>
                </tr>
            </thead>
            <tbody id="unitTableBody"></tbody>
        </table>
    </div>
</div>

<div id="unitModal" class="modal">
    <div class="modal-content" style="max-width: 800px; height: 700px; display: flex; flex-direction: column;">
        <h3 id="modalTitle">編輯單位資料</h3>
        <input type="hidden" id="originalUnitId">
        <input type="hidden" id="currentMode" value="edit">

        <div class="tab-header">
            <button class="tab-btn active" onclick="unitManager.switchTab('info')">單位資訊</button>
            <button class="tab-btn" onclick="unitManager.switchTab('group')">組別資訊</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding-right: 10px; padding-bottom: 10px;">
            
            <div id="tab-info" class="tab-content active">
                <div class="form-row">
                    <div class="form-group">
                        <label>單位代碼 (ID) *</label>
                        <input type="text" id="inputUnitId" placeholder="例如: ICU01">
                        <small style="color:#666;">建立後無法修改</small>
                    </div>
                    <div class="form-group">
                        <label>單位名稱 *</label>
                        <input type="text" id="inputUnitName" placeholder="例如: 內科加護病房">
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

                <div class="form-row">
                    <div class="form-group" style="flex:1;" id="containerManagerAuth">
                        <label style="color:#e67e22; font-weight:bold;">單位管理者 (可複選)</label>
                        <input type="text" id="searchManagerInput" placeholder="搜尋姓名..." 
                               style="width:100%; padding:8px; margin-bottom:5px; border:1px solid #ddd; font-size:0.9rem;"
                               oninput="unitManager.filterUserList('manager')">
                        
                        <div id="managerListContainer" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:0; background:#fff; border-radius:4px; text-align: left;">
                            </div>
                    </div>

                    <div class="form-group" style="flex:1;" id="containerSchedulerAuth">
                        <label style="color:#27ae60; font-weight:bold;">排班人員 (可複選)</label>
                        <input type="text" id="searchSchedulerInput" placeholder="搜尋姓名..." 
                               style="width:100%; padding:8px; margin-bottom:5px; border:1px solid #ddd; font-size:0.9rem;"
                               oninput="unitManager.filterUserList('scheduler')">

                        <div id="schedulerListContainer" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:0; background:#fff; border-radius:4px; text-align: left;">
                            </div>
                    </div>
                </div>
            </div>

            <div id="tab-group" class="tab-content">
                <div class="group-manage-container">
                    
                    <div class="group-left-panel">
                        <h4 style="margin-top:0;">組別設定</h4>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="inputNewGroup" placeholder="新組別名稱" style="flex:1; padding:5px;">
                            <button class="btn btn-add" style="padding:5px 10px;" onclick="unitManager.addGroup()">新增</button>
                        </div>
                        <div id="groupListArea" class="scrollable-list">
                            </div>
                    </div>

                    <div class="group-right-panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="margin:0;">人員組別指派</h4>
                            <button class="btn btn-add" onclick="unitManager.saveUserGroups()">
                                <i class="fas fa-save"></i> 儲存設定
                            </button>
                        </div>
                        
                        <div style="display: flex; background: #eee; padding: 8px; font-weight: bold; border-radius: 4px 4px 0 0;">
                            <div style="flex: 1;">姓名 (員編)</div>
                            <div style="flex: 1;">所屬組別</div>
                        </div>
                        <div id="groupStaffListArea" class="scrollable-list" style="border-top: 0; border-radius: 0 0 4px 4px;">
                            <table style="width:100%; border-collapse: collapse;" id="tableGroupStaff">
                                </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div style="text-align:right; margin-top:15px; border-top: 1px solid #eee; padding-top: 10px;">
            <button class="btn btn-close" onclick="unitManager.closeModal()">關閉</button>
            <button id="btnSaveUnitInfo" class="btn btn-add" onclick="unitManager.saveUnitInfo()">儲存單位設定</button>
        </div>
    </div>
</div>

<div id="unitImportModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h3><i class="fas fa-file-import"></i> 批次匯入單位</h3>
        <div style="margin-bottom: 20px;">
            <button class="btn btn-close" style="background-color: #17a2b8; width: 100%;" onclick="unitManager.downloadTemplate()">
                <i class="fas fa-download"></i> 下載 CSV 範例檔
            </button>
        </div>
        <div style="margin-bottom: 20px;">
            <input type="file" id="csvUnitFile" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div id="unitImportResult" style="margin-bottom:15px; font-size: 0.9rem;"></div>
        <div style="text-align:right;">
            <button class="btn btn-close" onclick="unitManager.closeImportModal()">取消</button>
            <button class="btn btn-add" onclick="unitManager.processImport()">開始匯入</button>
        </div>
    </div>
</div>
